{"version":3,"sources":["components/profile/Profile.js","apps/ProfileApp.js","apps/MailApp.js","Home.js","Auth.js","Router.js","index.js","openweb/openweb.js","assets/anon.png","assets/gray_near_logo.svg","assets/encryptionOn.png","assets/encryptionOff.png","near/config.js"],"names":["Profile","props","state","displayName","profileUrl","bio","loading","found","window","profileComponentCache","profileCache","app","OpenWebApp","nearConfig","init","this","accountId","ready","then","updateProfile","console","log","Promise","all","getFrom","values","catch","e","setState","fetchProfile","profile","onFetch","prevProps","anon","popover","Popover","className","id","Title","as","Content","src","alt","role","OverlayTrigger","placement","delay","show","hide","overlay","React","Component","ProfileApp","keys","reduce","acc","key","chainValues","initialized","map","get","i","Object","assign","value","length","forEach","set","f","sourceImage","Image","reader","FileReader","readAsDataURL","onload","canvas","document","createElement","aspect","naturalWidth","naturalHeight","width","Math","round","max","height","ctx","getContext","imageSmoothingQuality","fillStyle","fillRect","drawImage","options","toDataURL","sort","a","b","handleChange","event","target","result","onClick","logOut","htmlFor","placeholder","disabled","onChange","type","onFilesChange","onError","onFilesError","multiple","accepts","minFileSize","clickable","save","MailApp","receiverId","subject","content","sending","numLetters","unread","expandedId","profileFound","profileLoading","keyLoading","theirPublicKey64","inbox","textarea","createRef","keyCache","letter","messageId","undefined","filter","push","time","read","onNewMail","version","num","allMigrations","encrypted","resolve","storeEncryptionPublicKey","migrateFrom","modifyLetter","fetchMessages","encryptionKey","fetchKey","stateChange","toLowerCase","replace","fetchTimeoutId","clearTimeout","pullMessage","message","setTimeout","inner","JSON","parse","isEncrypted","fromAppId","appId","decryptMessage","sender","decryptedMessage","trunc","newNumLetters","warn","error","stringify","encryptMessage","sendMessage","startsWith","Date","toLocaleDateString","join","split","s","current","focus","setSelectionRange","scrollLeft","scrollTop","remove","encryptionEnabled","displayEncryptionIcon","encryptionAlt","encryptionIcon","encryptionOn","encryptionOff","title","updateKey","expanded","deleteLetter","replyTo","selectLetter","aria-label","receiverClass","ref","rows","sendMail","Letter","t","toLocaleString","d","getDate","hour","getHours","minute","getMinutes","toString","padStart","daytime","timeFormat","Home","requestSignOut","wallet","signOut","signedOutFlow","isSignedIn","location","search","includes","origin","pathname","login","apps","logs","signedInFlow","bind","requestSignIn","checkSignIn","initOpenWebApp","nearlib","walletAccount","concat","getAccountId","near","connection","account","code_hash","fetch","data","arrayBuffer","buf","deployContract","Uint8Array","viewMethods","changeMethods","contract","new","masterContract","graph","mail","getAccessPublicKey","pk","args","public_key","serialize","SCHEMA","app_id","add_app_key","onKeyAdded","forceRenderTabPanel","nearlogo","Auth","queryString","pub_key","authorized","new_app_id","new_pub_key","res","Router","basename","process","hashType","exact","path","component","nearInitPromise","async","getConfig","deps","keyStore","BrowserLocalStorageKeyStore","ReactDOM","render","getElementById","config","_config","blocking","parseEncryptionKey","nacl","Buffer","keyKey","localStorage","getItem","keyPair","fromSecretKey","from","setItem","secretKey","_key","_keyStore","_near","_account","_contract","_networkId","networkId","_ready","_innerInit","getKey","getPublicKey","_tmpKey","accessKey","fromRandom","publicKey","getEncryptionPublicKey","Error","setKey","call","msg64","nonce","nonceLength","copy","box","decodedBuf","open","str","fullBuf","theirPublicKey","publicKeyLength","decryptSecretBox","forceReady","wrappedCall","encryptSecretBox","num_messages","pull_message","getTheirPublicKey","encryptBox","decryptBox","send_message","receiver_id","module","exports","env","nodeUrl","contractName","walletUrl","keyPath","HOME","masterAccount","Cookies","require","cookieConfig","getJSON","nearPages"],"mappings":"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","file":"static/js/main.35a381af.chunk.js","sourcesContent":["import React from \"react\";\nimport anon from \"../../assets/anon.png\";\nimport {OpenWebApp} from \"../../openweb/openweb\";\nimport Popover from \"react-bootstrap/Popover\";\nimport OverlayTrigger from \"react-bootstrap/OverlayTrigger\";\n\nconst profileAppId = \"profile\";\n\nexport class Profile extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      displayName: \"\",\n      profileUrl: null,\n      bio: \"\",\n      loading: false,\n      found: false,\n    }\n    if (!window.profileComponentCache) {\n      window.profileComponentCache = {\n        profileCache: {},\n        app: new OpenWebApp(profileAppId, null, window.nearConfig),\n      };\n      window.profileComponentCache.app.init();\n    }\n\n    this.profileCache = window.profileComponentCache.profileCache;\n    this.app = window.profileComponentCache.app;\n  }\n\n  componentDidMount() {\n    this.props.accountId && this.app.ready().then(() => this.updateProfile(this.props.accountId));\n  }\n\n  async fetchProfile(accountId) {\n    if (accountId in this.profileCache) {\n      return await this.profileCache[accountId];\n    } else {\n      console.log(\"Fetching profile for \" + accountId);\n      this.profileCache[accountId] = Promise.all([\n        this.app.getFrom(accountId, 'displayName'),\n        this.app.getFrom(accountId, 'profileUrl'),\n        this.app.getFrom(accountId, 'bio'),\n      ]).then((values) => {\n        return {\n          accountId,\n          displayName: values[0] || \"\",\n          profileUrl: values[1],\n          bio: values[2] || \"\",\n        };\n      }).catch((e) => false);\n      return await this.profileCache[accountId];\n    }\n  }\n\n  updateProfile(accountId) {\n    this.setState({\n      displayName: \"\",\n      profileUrl: null,\n      bio: \"\",\n      loading: true,\n      found: false,\n    });\n    this.fetchProfile(this.props.accountId).then((profile) => {\n      if (profile) {\n        this.setState({\n          displayName: profile.displayName,\n          profileUrl: profile.profileUrl,\n          bio: profile.bio,\n          loading: false,\n          found: true,\n        });\n      } else {\n        this.setState({\n          loading: false,\n          found: false,\n        });\n      }\n      this.props.onFetch && this.props.onFetch(profile);\n    })\n\n  }\n\n  componentDidUpdate(prevProps) {\n    if (this.props.accountId !== prevProps.accountId) {\n      this.updateProfile(this.props.accountId);\n    }\n  }\n\n  render() {\n    const displayName = this.props.displayName || this.state.displayName;\n    const profileUrl = this.props.profileUrl || this.state.profileUrl || anon;\n    const bio = this.props.bio || this.state.bio;\n    const popover = <Popover className=\"profile-popover\" id={\"profile-popover-\" + this.props.accountId}>\n      <Popover.Title as=\"h3\">{displayName}</Popover.Title>\n      <Popover.Content>\n        <div>\n          <img className=\"profile-image\" src={profileUrl} alt={`Profile @${this.props.accountId}`}/>\n          <span className=\"profile-account-id\">{\"@\" + this.props.accountId}</span>\n        </div>\n        <div>\n          {bio}\n        </div>\n      </Popover.Content>\n    </Popover>;\n    return this.state.loading ? (\n      <div className=\"profile\">\n        <div className=\"spinner-grow\" role=\"status\">\n          <span className=\"sr-only\">Loading...</span>\n        </div>\n      </div>\n    ) : this.state.found ? (\n      <OverlayTrigger\n        placement=\"auto\"\n        delay={{ show: 250, hide: 100 }}\n        overlay={popover}\n      >\n        <div className=\"profile\">\n          <img className=\"profile-image\" src={profileUrl} alt={`Profile @${this.props.accountId}`}/>\n          <span className=\"profile-name\">\n            <span className=\"profile-display-name\">{displayName}</span>\n            <span className=\"profile-account-id\">{\"(@\" + this.props.accountId + \")\"}</span>\n          </span>\n        </div>\n      </OverlayTrigger>\n    ) : null;\n  }\n}","import React from \"react\";\nimport anon from \"../assets/anon.png\";\nimport Files from \"react-files\";\nimport {Profile} from \"../components/profile/Profile\";\n\nconst uploadResizeWidth = 96;\nconst uploadResizeHeight = 96;\n\nexport class ProfileApp extends React.Component {\n\n  constructor(props) {\n    super(props);\n    const keys = [\n      \"displayName\",\n      \"profileUrl\",\n      \"bio\",\n    ];\n    this.state = keys.reduce((acc, key) => {\n      acc[key] = \"\";\n      acc.chainValues[key] = null;\n      return acc;\n    }, {\n      keys,\n      chainValues: {},\n      initialized: false,\n    });\n  }\n\n  async init() {\n    this.setState({\n      initialized: true,\n    });\n    const values = await Promise.all(this.state.keys.map((key) => this.props.app.get(key)));\n    const chainValues = this.state.keys.reduce((acc, key, i) => {\n      acc[key] = values[i] || \"\";\n      return acc;\n    }, {});\n    this.setState(Object.assign({chainValues}, chainValues));\n  }\n\n  componentDidUpdate(prevProps) {\n    if (this.props.app && !this.state.initialized) {\n      this.init();\n    }\n  }\n\n  handleChange(key, value) {\n    console.log(value.length);\n    this.setState({\n      [key]: value,\n    });\n  }\n\n  async save() {\n    console.log(\"Saving\");\n    const chainValues = Object.assign({}, this.state.chainValues);\n    this.state.keys.forEach(key => {\n      if (this.state.chainValues[key] !== this.state[key]) {\n        chainValues[key] = this.state[key];\n        this.props.app.set(key, this.state[key]).then(() => {\n          console.log(\"Updated key `\" + key + \"` to value `\" + this.state[key] + '`');\n        });\n      }\n    });\n    this.setState({\n      chainValues\n    })\n  }\n\n  async onFilesChange(f) {\n    let sourceImage = new Image();\n    let reader = new FileReader();\n\n    reader.readAsDataURL(f[0]);\n\n    sourceImage.onload = () => {\n      // Create a canvas with the desired dimensions\n      let canvas = document.createElement(\"canvas\");\n      const aspect = sourceImage.naturalWidth / sourceImage.naturalHeight;\n      const width = Math.round(uploadResizeWidth * Math.max(1, aspect));\n      const height = Math.round(uploadResizeHeight * Math.max(1, 1 / aspect));\n      canvas.width = uploadResizeWidth;\n      canvas.height = uploadResizeHeight;\n      const ctx = canvas.getContext(\"2d\");\n\n      // Scale and draw the source image to the canvas\n      ctx.imageSmoothingQuality = \"high\";\n      ctx.fillStyle = \"#fff\";\n      ctx.fillRect(0, 0, uploadResizeWidth, uploadResizeHeight);\n      ctx.drawImage(sourceImage, (uploadResizeWidth - width) / 2, (uploadResizeHeight - height) / 2, width, height);\n\n      // Convert the canvas to a data URL in PNG format\n      const options = [\n        canvas.toDataURL('image/jpeg', 0.92),\n        canvas.toDataURL('image/webp', 0.92),\n        canvas.toDataURL('image/png')\n      ];\n      options.sort((a, b) => a.length - b.length);\n\n      this.handleChange('profileUrl', options[0]);\n    }\n\n    reader.onload = function(event) {\n      sourceImage.src = event.target.result;\n    };\n  }\n\n  async onFilesError(e, f) {\n    console.log(e, f);\n  }\n\n  render() {\n    return (\n      <div>\n        <div>\n          <button className=\"float-right\" onClick={this.props.logOut}>Log out</button>\n          <Profile\n            accountId={this.props.app && this.props.app.accountId}\n            profileUrl={this.state.profileUrl}\n            displayName={this.state.displayName}\n            bio={this.state.bio}\n          />\n        </div>\n        <hr/>\n        <div>\n          <div className=\"form-group\">\n            <label htmlFor=\"displayName\">Display Name</label>\n            <input placeholder=\"The REAL Satoshi\" id=\"displayName\" className=\"form-control\" disabled={!this.props.app} value={this.state.displayName} onChange={(e) => this.handleChange('displayName', e.target.value)} />\n          </div>\n          <label htmlFor=\"profileUrl\">Profile URL</label>\n          <div className=\"input-group\">\n            <input placeholder={\"https://metanear.com\" + anon} id=\"profileUrl\" className=\"form-control\" disabled={!this.props.app} value={this.state.profileUrl}\n                   onChange={(e) => this.handleChange('profileUrl', e.target.value)}/>\n            <div className=\"input-group-append\">\n              <Files\n                type=\"button\"\n                className='btn btn-outline-primary'\n                onChange={(f) => this.onFilesChange(f)}\n                onError={(e, f) => this.onFilesError(e, f)}\n                multiple={false}\n                accepts={['image/*']}\n                minFileSize={1}\n                clickable\n              >\n                Click to upload\n              </Files>\n            </div>\n\n          </div>\n          <div className=\"form-group\">\n            <label htmlFor=\"bio\">Bio</label>\n            <textarea placeholder=\"I'm working on Bitcoin, so bankers can go home.\" id=\"bio\" className=\"form-control\" disabled={!this.props.app} value={this.state.bio} onChange={(e) => this.handleChange('bio', e.target.value)} />\n          </div>\n          <div className=\"form-group\">\n            <button onClick={() => this.save()}>Save changes</button>\n          </div>\n        </div>\n      </div>\n    )\n  }\n}","import React from \"react\";\nimport encryptionOn from \"../assets/encryptionOn.png\";\nimport encryptionOff from \"../assets/encryptionOff.png\";\nimport {encryptionKey} from \"../openweb/openweb\";\nimport {Profile} from \"../components/profile/Profile\";\n\nconst RE = \"Re: \";\nconst currentVersion = 2;\n\nexport class MailApp extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      initialized: false,\n      receiverId: \"\",\n      subject: \"\",\n      content: \"\",\n      sending: false,\n      numLetters: 0,\n      unread: 0,\n      expandedId: -1,\n      profileFound: false,\n      profileLoading: false,\n      keyLoading: false,\n      theirPublicKey64: null,\n      inbox: [],\n    }\n    this.textarea = React.createRef();\n    this.keyCache = {};\n  }\n\n  modifyLetter(letter, messageId) {\n    if (messageId === undefined) {\n      if (!letter) {\n        return;\n      }\n      messageId = letter.messageId;\n    }\n    const inbox = this.state.inbox.filter((a) => a.messageId !== messageId);\n    if (letter) {\n      inbox.push(letter);\n    }\n    inbox.sort((a, b) => b.time - a.time);\n    const unread = inbox.reduce((acc, letter) => acc + (letter.read ? 0: 1), 0);\n    this.setState({\n      inbox,\n      unread,\n    });\n    this.props.onNewMail(unread);\n  }\n\n  async migrateFrom(version) {\n    if (version === 0) {\n      console.log(\"Migrating from version #0\");\n      let num = 0;\n      try {\n        num = await this.props.app.get('numLetters');\n      } catch (e) {\n        // whatever. Probably died during migration.\n      }\n      const allMigrations = [];\n      for (let i = 0; i < num; ++i) {\n        allMigrations.push(this.props.app.get('letter_' + i).then((letter) => {\n          if (letter) {\n            return this.props.app.set('letter_' + i, letter, {encrypted: true}).then(() => {\n              console.log(\"Migrated letter #\" + i);\n            })\n          }\n          return Promise.resolve();\n        }).catch((e) => console.log(\"Can't migrate letter #\", i, e)));\n      }\n      await Promise.all(allMigrations);\n      await this.props.app.set('numLetters', num, { encrypted: true });\n      version++;\n    }\n    if (version === 1) {\n      console.log(\"Migrating from version #1\");\n      await this.props.app.storeEncryptionPublicKey();\n      version++;\n    }\n    await this.props.app.set('version', version, { encrypted: true });\n  }\n\n  async init() {\n    this.setState({\n      initialized: true,\n    });\n    const version = await this.props.app.get('version', { encrypted: true }) || 0;\n    if (version < currentVersion) {\n      await this.migrateFrom(version);\n    }\n    const num = await this.props.app.get('numLetters', { encrypted: true }) || 0;\n    this.setState({\n      numLetters: num,\n    });\n    for (let i = Math.max(0, num - 10); i < num; ++i) {\n      this.props.app.get('letter_' + i, {encrypted: true}).then((letter) => this.modifyLetter(letter));\n    }\n    this.fetchMessages();\n  }\n\n  componentDidUpdate(prevProps) {\n    if (this.props.app && !this.state.initialized) {\n      this.init();\n    }\n  }\n\n  async fetchKey(accountId) {\n    if (accountId in this.keyCache) {\n      return await this.keyCache[accountId];\n    } else {\n      console.log(\"Fetching key for \" + accountId);\n      this.keyCache[accountId] = this.props.app.getFrom(accountId, encryptionKey).catch((e) => false);\n      return await this.keyCache[accountId];\n    }\n  }\n\n  updateKey(profile) {\n    if (!this.props.app) {\n      return;\n    }\n    this.setState({\n      profileLoading: false,\n      profileFound: !!profile,\n    });\n    if (!profile) {\n      return;\n    }\n    this.setState({\n      keyLoading: true,\n    })\n    this.fetchKey(profile.accountId).then((theirPublicKey64) => {\n      this.setState({\n        keyLoading: false,\n        theirPublicKey64,\n      })\n    });\n  }\n\n  handleChange(key, value) {\n    const stateChange = {\n      [key]: value,\n    };\n    if (key === 'receiverId') {\n      value = value.toLowerCase().replace(/[^a-z0-9\\-_.]/, '');\n      stateChange[key] = value;\n      stateChange.profileLoading = true;\n      stateChange.theirPublicKey64 = false;\n    }\n    this.setState(stateChange);\n  }\n\n  async fetchMessages() {\n    if (!this.props.app) {\n      return;\n    }\n    if (this.fetchTimeoutId) {\n      clearTimeout(this.fetchTimeoutId);\n      this.fetchTimeoutId = null;\n    }\n    console.log(\"Fetching messages\");\n    const message = await this.props.app.pullMessage();\n    if (!message) {\n      this.fetchTimeoutId = setTimeout(() => { this.fetchMessages() }, 60 * 1000);\n      return;\n    }\n    try {\n      console.log(message);\n      let inner = JSON.parse(message.message);\n      const isEncrypted = inner.type === 'encrypted';\n      const fromAppId = inner.fromAppId || this.props.app.appId;\n      if (isEncrypted) {\n        const decryptedMessage = await this.props.app.decryptMessage(inner.content, {\n          accountId: message.sender,\n          appId: inner.fromAppId,\n        });\n        inner = JSON.parse(decryptedMessage);\n      }\n      if (inner.type === 'mail') {\n        const letter = {\n          messageId: this.state.numLetters,\n          isEncrypted,\n          fromAppId,\n          sender: message.sender,\n          subject: inner.subject,\n          content: inner.content,\n          time: Math.trunc(message.time / 1000000),\n        }\n        const newNumLetters = this.state.numLetters + 1;\n        this.setState({\n          numLetters: newNumLetters,\n        });\n\n        this.props.app.set(\"letter_\" + letter.messageId, letter, {encrypted: true}).then(() => {\n          console.log(\"Saved the letter: \", letter);\n        });\n        this.props.app.set(\"numLetters\", newNumLetters, {encrypted: true}).then(() => {\n            console.log(\"Saved the new number of letters: \", newNumLetters);\n        });\n        this.modifyLetter(letter);\n      } else {\n        console.warn(\"Unknown message\", message);\n      }\n    } catch (e) {\n      console.error(e);\n    } finally {\n      this.fetchMessages()\n    }\n  }\n\n  async sendMail() {\n    if (!this.state.profileFound) {\n      return;\n    }\n    console.log(\"Sending mail\");\n    this.setState({\n      sending: true,\n    });\n    try {\n      let message = JSON.stringify({\n        type: \"mail\",\n        subject: this.state.subject,\n        content: this.state.content,\n      });\n      if (this.state.theirPublicKey64) {\n        const content = await this.props.app.encryptMessage(message, {\n          theirPublicKey64: this.state.theirPublicKey64,\n        });\n        message = JSON.stringify({\n          type: \"encrypted\",\n          fromAppId: this.props.app.appId,\n          content,\n        })\n      }\n      await this.props.app.sendMessage(this.state.receiverId, message);\n      this.setState({\n        subject: \"\",\n        content: \"\",\n      })\n    } catch (e) {\n      console.log(\"Failed to send the message\", e);\n    } finally {\n      this.setState({\n        sending: false,\n      });\n      this.fetchMessages();\n    };\n  }\n\n  receiverClass() {\n    if (!this.state.receiverId || this.state.profileLoading) {\n      return \"form-control\";\n    } else if (this.state.profileFound) {\n      return \"form-control is-valid\";\n    } else {\n      return \"form-control is-invalid\";\n    }\n  }\n\n  replyTo(letter, displayName) {\n    this.handleChange(\"receiverId\", letter.sender);\n    this.setState({\n      subject: (letter.subject.startsWith(RE) ? \"\" : RE) + letter.subject,\n      content: [\n        \"\",\n        \"\",\n        [\"On\", new Date(letter.time).toLocaleDateString(), displayName, \"@\" + letter.sender, \"wrote:\"].join(' '),\n        ...letter.content.split(/\\r?\\n/).map(s => \"| \" + s)\n      ].join(\"\\n\"),\n    }, () => {\n      this.textarea.current.focus();\n      this.textarea.current.setSelectionRange(0, 0);\n      this.textarea.current.scrollLeft = 0;\n      this.textarea.current.scrollTop = 0;\n    });\n  }\n\n  selectLetter(letter) {\n    this.setState({\n      expandedId: (this.state.expandedId === letter.messageId) ? -1 : letter.messageId,\n    });\n    if (!letter.read) {\n      letter = JSON.parse(JSON.stringify(letter));\n      letter.read = true;\n      this.props.app.set(\"letter_\" + letter.messageId, letter, {encrypted: true}).then(() => {\n        console.log(\"Saved the letter: \", letter);\n      });\n      this.modifyLetter(letter);\n    }\n  }\n\n  deleteLetter(letter) {\n    this.props.app.remove(\"letter_\" + letter.messageId).then(() => {\n      console.log(\"Deleted the letter: \", letter);\n    });\n    this.modifyLetter(null, letter.messageId);\n  }\n\n  render() {\n    const encryptionEnabled = this.state.theirPublicKey64;\n    const displayEncryptionIcon = this.state.profileFound && !this.state.keyLoading;\n    const encryptionAlt = encryptionEnabled ? \"Encryption is ON\" : \"Not secure! Encryption is OFF\";\n    const encryptionIcon = displayEncryptionIcon &&\n      <img className=\"encryption-icon\" src={encryptionEnabled ? encryptionOn : encryptionOff}\n          title={encryptionAlt} alt={encryptionAlt}/>;\n    const profile = <Profile accountId={this.state.receiverId} onFetch={(profile) => this.updateKey(profile)} />;\n    const inbox = this.state.inbox.map((letter, i) => (\n      <Letter\n        key={letter.messageId}\n        letter={letter}\n        expanded={letter.messageId === this.state.expandedId}\n        deleteLetter={(letter) => this.deleteLetter(letter)}\n        replyTo={(letter, displayName) => this.replyTo(letter, displayName)}\n        selectLetter={(letter) => this.selectLetter(letter)} />\n    ));\n    return (\n      <div>\n        Inbox <button className=\"btn btn-sm\" onClick={() => this.fetchMessages()}><span role=\"img\" aria-label=\"Refresh\">ðŸ”„</span></button>\n        <div>\n          {inbox}\n        </div>\n        <h3>Send</h3>\n        <div className=\"form-row\">\n          <div className=\"col\">\n            <div className=\"form-group\">\n              <label className=\"sr-only\" htmlFor=\"toAccountId\">To Account ID</label>\n              <div className=\"input-group\">\n                <div className=\"input-group-prepend\">\n                  <div className=\"input-group-text\">@</div>\n                </div>\n                <input type=\"text\" className={this.receiverClass()} id=\"toAccountId\" placeholder=\"To Account ID\" value={this.state.receiverId} disabled={!this.props.app} onChange={(e) => this.handleChange('receiverId', e.target.value)} />\n              </div>\n            </div>\n          </div>\n          {profile}\n        </div>\n        <div className=\"form-group\">\n          <label className=\"sr-only\" htmlFor=\"subject\">Subject</label>\n          <input type=\"text\" className=\"form-control\" id=\"subject\" placeholder=\"Subject\" disabled={!this.props.app} value={this.state.subject} onChange={(e) => this.handleChange('subject', e.target.value)} />\n        </div>\n        <div className=\"form-group\">\n          <textarea ref={this.textarea} id=\"content\" className=\"form-control\" rows=\"7\" disabled={!this.props.app} value={this.state.content} onChange={(e) => this.handleChange('content', e.target.value)} />\n        </div>\n        <div className=\"form-group\">\n          <button className={\"form-control form-control-lg btn \" + (displayEncryptionIcon && !encryptionEnabled ? \"btn-danger\" : \"btn-primary\")} disabled={!this.state.profileFound || this.state.sending} onClick={() => this.sendMail()}>\n            Send {encryptionIcon}</button>\n        </div>\n      </div>\n    )\n  }\n}\n\nexport class Letter extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      profile: {\n        profileUrl: null,\n        displayName: '@' + props.letter.sender,\n      },\n    };\n  }\n\n  onClick() {\n    this.props.selectLetter(this.props.letter);\n  }\n\n  render() {\n    const profile = (\n      <div className=\"col-sm-6 col-md-4 col-lg-4 letter-profile\">\n        <Profile accountId={this.props.letter.sender} onFetch={(profile) => profile && this.setState({displayName: profile.displayName})}/>\n      </div>\n    );\n    const subject = (\n      <div className=\"col-sm-4 col-md\">\n        <div className=\"letter-subject\">{this.props.letter.subject}</div>\n      </div>\n    );\n    const time = this.props.expanded ? (\n      <div className=\"col-sm-2 col-lg-2\">\n        <div className=\"letter-time\">{longTimeFormat(this.props.letter.time)}</div>\n      </div>\n    ) : (\n      <div className=\"col-sm-2 col-lg-1 d-none d-md-block\">\n        <div className=\"letter-time\">{timeFormat(this.props.letter.time)}</div>\n      </div>\n    );\n    if (this.props.expanded) {\n      return (\n        <div className=\"letter letter-expanded\">\n          <div className=\"row letter-expanded-header\" onClick={() => this.onClick()}>\n            {profile}\n            {subject}\n            {time}\n          </div>\n          <div className=\"letter-content-expanded\">\n            <pre>{this.props.letter.content}</pre>\n            <div className=\"row\">\n              <div className=\"col-sm\">\n                <button className=\"btn btn-primary\" onClick={() => this.props.replyTo(this.props.letter, this.state.displayName)}>Reply</button>\n              </div>\n              <div className=\"col-sm\">\n                <button className=\"btn btn-danger float-right\" onClick={() => this.props.deleteLetter(this.props.letter)}>DELETE THIS!</button>\n              </div>\n            </div>\n          </div>\n        </div>\n      );\n    } else {\n      return (\n        <div className={\"row letter letter-small\" + (this.props.letter.read ? \" letter-read\" : \" letter-unread\")} onClick={() => this.onClick()}>\n          {profile}\n          {subject}\n          <div className=\"col-sm d-none d-lg-block\">\n            <div className=\"letter-content\">{this.props.letter.content}</div>\n          </div>\n          {time}\n        </div>\n      );\n    }\n  }\n}\n\nfunction longTimeFormat(t) {\n  return new Date(t).toLocaleString();\n}\n\nfunction timeFormat(t) {\n  const d = new Date(t);\n  const now = new Date();\n  if (now.getDate() === d.getDate()) {\n    const hour = d.getHours() % 12;\n    const minute = d.getMinutes().toString().padStart(2, '0');\n    const daytime = d.getHours() >= 12 ? \"PM\" : \"AM\";\n    return `${hour}:${minute} ${daytime}`;\n  } else {\n    return d.toLocaleDateString();\n  }\n}\n","import React, { Component } from 'react';\nimport nearlogo from './assets/gray_near_logo.svg';\nimport './css/App.css';\nimport * as nearlib from \"nearlib\";\nimport { OpenWebApp } from './openweb/openweb.js';\nimport { ProfileApp } from \"./apps/ProfileApp\";\nimport { MailApp } from \"./apps/MailApp\";\nimport { Tab, Tabs, TabList, TabPanel } from 'react-tabs';\nimport 'react-tabs/style/react-tabs.css';\n\nconst GAS = 2_000_000_000_000_000;\nconst TITLE = \"Open Web Home - NEAR\"\n\nexport class Home extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      login: false,\n      apps: {},\n      logs: [],\n      unread: 0,\n      loading: false,\n    }\n    this.signedInFlow = this.signedInFlow.bind(this);\n    this.requestSignIn = this.requestSignIn.bind(this);\n    this.requestSignOut = this.requestSignOut.bind(this);\n    this.signedOutFlow = this.signedOutFlow.bind(this);\n    this.checkSignIn = this.checkSignIn.bind(this);\n    this.initOpenWebApp = this.initOpenWebApp.bind(this);\n    window.nearlib = nearlib;\n  }\n\n  componentDidMount() {\n    this.checkSignIn();\n  }\n\n  async checkSignIn() {\n    let loggedIn = window.walletAccount.isSignedIn();\n    if (loggedIn) {\n      await this.signedInFlow();\n    } else {\n      this.signedOutFlow();\n    }\n  }\n\n  log(message) {\n    console.log(message);\n    this.setState({\n      logs: this.state.logs.concat([message])\n    })\n  }\n\n  async signedInFlow() {\n    const accountId = await this.props.wallet.getAccountId()\n    this.setState({\n      login: true,\n      loading: true,\n      accountId,\n    })\n    if (window.location.search.includes(\"account_id\")) {\n      window.location.replace(window.location.origin + window.location.pathname)\n    }\n    if (window.location.search.includes(\"all_keys\")) {\n      window.location.replace(window.location.origin + window.location.pathname)\n    }\n    // Initializing our contract APIs by contract name and configuration.\n\n    this.log(\"Connecting to account...\");\n    const account = await new nearlib.Account(window.near.connection, accountId);\n    this.log(\"Querying state...\");\n    let state = await account.state();\n    /*\n    await new Promise((resolve, reject) =>{\n      setTimeout(() => {\n        resolve();\n      }, 5000);\n    })\n     */\n    console.log(state);\n    if (state.code_hash !== 'C8UmYSqATkuyhheJ7i7ryxPjfZL4nV8PfkovdMKitsmJ') {\n      this.log(\"Going to deploy the code\");\n      // no code. Need to deploy.\n      this.log(\"Downloading started...\");\n      let data = await fetch('/open_web.wasm');\n      let buf = await data.arrayBuffer();\n      this.log(\"Downloading done. Deploying contract...\");\n      await account.deployContract(new Uint8Array(buf));\n      if (state.code_hash === '11111111111111111111111111111111') {\n        this.log(\"Deploying done. Initializing contract...\");\n        // Gotta init it.\n        let contract = await new nearlib.Contract(account, accountId, {\n          viewMethods: [],\n          // Change methods can modify the state. But you don't receive the returned value when called.\n          changeMethods: ['new'],\n          // Sender is the account ID to initialize transactions.\n          sender: accountId\n        });\n        console.log(await contract.new());\n      }\n      this.log(\"The contract is deployed\");\n    }\n\n    const masterContract = await new nearlib.Contract(account, accountId, {\n      // View methods are read only. They don't modify the state, but usually return some value.\n      viewMethods: ['apps'],\n      // Change methods can modify the state. But you don't receive the returned value when called.\n      changeMethods: ['add_app_key', 'remove_app_key'],\n      // Sender is the account ID to initialize transactions.\n      sender: accountId\n    });\n\n    this.masterContract = masterContract;\n    window.masterContract = masterContract;\n    this.log(\"Fetching authorized apps...\");\n    console.log(\"Apps:\", await masterContract.apps());\n\n    // this.initOpenWebApp = this.initOpenWebApp.bind(this);\n    \n    this.log(\"Initializing local apps...\");\n    const apps = {\n      profile: await this.initOpenWebApp('profile', accountId),\n      graph: await this.initOpenWebApp('graph', accountId),\n      mail: await this.initOpenWebApp('mail', accountId)\n    };\n    window.apps = apps;\n    this.apps = apps;\n    this.setState({\n      apps,\n      loading: false,\n    })\n  }\n\n  async initOpenWebApp(appId, accountId) {\n    this.log(\"Initializing app: \" + appId + \" ...\");\n    const app = new OpenWebApp(appId, accountId, window.nearConfig);\n    await app.init();\n    if (!await app.ready()) {\n      let pk = await app.getAccessPublicKey();\n      this.log(\"Authorizing app for key \" + pk.toString() + \" ...\");\n      const args = {\n        public_key: [...nearlib.utils.serialize.serialize(nearlib.transactions.SCHEMA, pk)],\n        app_id: appId,\n      };\n      await this.masterContract.add_app_key(args, GAS);\n      await app.onKeyAdded();\n    }\n    return app;\n  }\n\n  async requestSignIn() {\n    const appTitle = 'Open Web Home';\n    await this.props.wallet.requestSignIn(\n      \"\",\n      appTitle\n    )\n  }\n\n  requestSignOut = () => {\n    this.props.wallet.signOut();\n    setTimeout(this.signedOutFlow, 500);\n    console.log(\"after sign out\", this.props.wallet.isSignedIn())\n  }\n\n\n  signedOutFlow = () => {\n    if (window.location.search.includes(\"account_id\")) {\n      window.location.replace(window.location.origin + window.location.pathname)\n    }\n    this.setState({\n      login: false,\n    })\n  }\n\n  render() {\n    document.title = (this.state.unread ? `(${this.state.unread}) ` : \"\") + TITLE;\n    if (!this.state.login) {\n      return <div className=\"App-header\">\n        <div>\n          <div className=\"image-wrapper\">\n            <img className=\"logo\" src={nearlogo} alt=\"NEAR logo\"/>\n          </div>\n          <h1>Hello ?</h1>\n          <div>\n            <button onClick={this.requestSignIn}>Log in with NEAR</button>\n          </div>\n        </div>\n      </div>\n    } else {\n      return <div>\n        {this.state.loading && (\n          <div className=\"loading-div\">\n            <div className=\"spinner-grow loading-spinner\" role=\"status\">\n              <span className=\"sr-only\">Loading...</span>\n            </div>\n            <pre className=\"text-left\">\n            {this.state.logs.join(\"\\n\")}\n          </pre>\n          </div>\n        )}\n        <div className={\"apps\" + (this.state.loading ? \" d-none\" : \"\")}>\n          <Tabs forceRenderTabPanel={true}>\n            <TabList>\n              <Tab>Profile</Tab>\n              <Tab>Mail {this.state.unread ? `(${this.state.unread})` : \"\"}</Tab>\n            </TabList>\n\n            <TabPanel>\n              <ProfileApp app={this.state.apps.profile} logOut={this.requestSignOut}/>\n            </TabPanel>\n            <TabPanel>\n              <MailApp app={this.state.apps.mail} onNewMail={(unread) => this.setState({unread})}/>\n            </TabPanel>\n          </Tabs>\n        </div>\n      </div>\n    }\n  }\n}\n","import React from \"react\";\nimport queryString from 'query-string';\n\nexport class Auth extends React.Component {\n  constructor(props) {\n    super(props);\n    const values = queryString.parse(this.props.location.search);\n    let {app_id, pub_key} = values;\n    if (app_id && pub_key) {\n      this.state = {\n        authorized:false,\n        new_app_id:app_id,\n        new_pub_key:pub_key\n      };\n    } else {\n      this.state = {\n        authorized:false,\n        new_app_id:\"\",\n        new_pub_key:\"\"\n      }\n    }\n  }\n\n componentDidMount() {\n    if (!this.props.loading && this.state.new_app_id && this.state.new_pub_key) {\n      this.props.initOpenWebApp(this.state.new_app_id, this.state.new_pub_key)\n        .then(res => {\n          this.setState({\n            authorized: true\n          })\n        });\n    }\n  }\n\n  componentDidUpdate(prevProps) {\n    if (this.props.app && !this.state.initialized) {\n      // this.init();\n    }\n  }\n  \n  // async fetchProfile(accountId) {\n  //   if (accountId in this.profileCache) {\n  //     return this.profileCache[accountId];\n  //   } else {\n  //     console.log(\"Fetching profile for \" + accountId);\n  //     try {\n  //       const values = await Promise.all([\n  //         this.props.app.getFrom(accountId, 'displayName', 'profile'),\n  //         this.props.app.getFrom(accountId, 'profileUrl', 'profile'),\n  //       ]);\n  //       this.profileCache[accountId] = {\n  //         displayName: values[0] || \"\",\n  //         profileUrl: values[1],\n  //       };\n  //     } catch (e) {\n  //       this.profileCache[accountId] = false;\n  //     }\n  //     return this.profileCache[accountId];\n  //   }\n  // }\n\n  // async registerNewApp(accountId) {\n  //   if (accountId in this.profileCache) {\n  //     return this.profileCache[accountId];\n  //   } else {\n  //     console.log(\"Fetching profile for \" + accountId);\n  //     try {\n  //       const values = await Promise.all([\n  //         this.props.app.getFrom(accountId, 'displayName', 'profile'),\n  //         this.props.app.getFrom(accountId, 'profileUrl', 'profile'),\n  //       ]);\n  //       this.profileCache[accountId] = {\n  //         displayName: values[0] || \"\",\n  //         profileUrl: values[1],\n  //       };\n  //     } catch (e) {\n  //       this.profileCache[accountId] = false;\n  //     }\n  //     return this.profileCache[accountId];\n  //   }\n  // }\n\n  render() {\n    return (\n      <div>\n        {this.state.authorized ? \n        <div>\n          <p>App <strong>{this.state.new_app_id}</strong> was added</p>\n          <p> Using the public key: {this.state.new_pub_key} </p>\n        </div> :\n        \"You need pass a key in order to add an app\"\n        }\n      </div>\n    )\n  }\n}\n","import React, { Component } from 'react';\nimport {HashRouter, Route, Switch} from \"react-router-dom\";\nimport { Home } from './Home';\nimport { Auth } from './Auth';\n\nclass Router extends Component {\n  render() {\n    return (\n      <HashRouter basename={process.env.PUBLIC_URL} hashType=\"noslash\">\n        <Switch>\n          <Route exact path=\"/\" component={() => <Home {...this.props}/>} />\n          <Route path=\"/auth\" component={() => <Auth {...this.props}/>} />\n        </Switch>\n      </HashRouter>\n    );\n  }\n}\n\nexport default Router;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport Router from './Router';\nimport getConfig from './near/config.js';\nimport * as nearlib from 'nearlib';\n\n// Initializing contract\nasync function InitContract() {\n    window.nearConfig = getConfig('development')\n\n    // Initializing connection to the NEAR DevNet.\n    window.near = await nearlib.connect(Object.assign({ deps: { keyStore: new nearlib.keyStores.BrowserLocalStorageKeyStore() } }, window.nearConfig));\n    \n    // Needed to access wallet login\n    window.walletAccount = new nearlib.WalletAccount(window.near);\n    \n    // Getting the Account ID. If unauthorized yet, it's just empty string.\n    window.accountId = window.walletAccount.getAccountId();\n\n}\n\nwindow.nearInitPromise = InitContract().then(() => {\n    ReactDOM.render(<Router contract={window.contract} wallet={window.walletAccount}/>,\n      document.getElementById('root')\n    );\n  }).catch(console.error)","import * as nearlib from \"nearlib\";\nimport * as nacl from \"tweetnacl\";\n\nconst GAS = 2_000_000_000_000_000;\n\nexport const encryptionKey = \"encryptionKey\";\n\n/**\n  a class representing the OpenWebApp API\n\n  this API supports local contract methods\n  - get: gets a value from local storage\n  - set: sets a value on local storage\n  - remove: deletes a value from local storage\n\n  and remote contract methods\n  - pull: reads a message from a remote contract\n  - post / send: sends a message to a remote contract\n */\nexport class OpenWebApp {\n  constructor(appId, accountId, config) {\n    this.appId = appId;\n    this.accountId = accountId;\n    this._config = config;\n    this.blocking = Promise.resolve();\n    this.parseEncryptionKey();\n    window.nacl = nacl;\n    window.Buffer = Buffer;\n  }\n\n  /**\n    read private key from local storage\n    - if found, recreate the related key pair\n    - if not found, create a new key pair and save it to local storage\n   */\n  parseEncryptionKey() {\n    const keyKey = \"enc_key:\" + this.accountId + \":\" + this.appId + \":\";\n    let key = localStorage.getItem(keyKey);\n    if (key) {\n      key = nacl.box.keyPair.fromSecretKey(Buffer.from(key, 'base64'));\n    } else {\n      key = new nacl.box.keyPair();\n      localStorage.setItem(keyKey, Buffer.from(key.secretKey).toString('base64'));\n    }\n    this._key = key;\n  }\n\n  async _innerInit() {\n    this._keyStore = new nearlib.keyStores.BrowserLocalStorageKeyStore(\n      localStorage, \"app:\" + this.appId,\n    );\n    this._near = await nearlib.connect(Object.assign({ deps: { keyStore:  this._keyStore } }, this._config));\n    this._account = new nearlib.Account(this._near.connection, this.accountId);\n    this._contract = new nearlib.Contract(this._account, this.accountId, {\n      viewMethods: ['get', 'apps', 'num_messages'],\n      changeMethods: ['set', 'remove', 'pull_message', 'send_message'],\n      sender: this.accountId\n    });\n    this._networkId = this._config.networkId;\n    return true;\n  }\n\n  /**\n    initialize the client-side application with a BrowserLocalStorageKeyStore\n    and a connection to the NEAR platform, binding OpenWebContract methods:\n\n    - get, set, remove: local invocation methods for controlling the state of local applications\n    - pull_message, send_message: remote invocation methods for communicating with contracts of other users\n    - apps, num_messages: convenience methods for listing all apps on the OpenWeb and messages for a specific app\n   */\n  async init() {\n    return this._ready || (this._ready = this._innerInit());\n  }\n\n  /**\n    helper method to check if the user is logged in with the app\n   */\n  async ready() {\n    return this.init();\n  }\n\n  /**\n    produce a public key on the user account\n    @return {string} existing (or create new) public key for the current account\n   */\n  async getAccessPublicKey() {\n    const key = await this._keyStore.getKey(this._networkId, this.accountId);\n    if (key) {\n      return key.getPublicKey();\n    }\n    if (this._tmpKey) {\n      return this._tmpKey.getPublicKey();\n    }\n    const accessKey = nearlib.KeyPair.fromRandom('ed25519');\n    this._tmpKey = accessKey;\n    return accessKey.getPublicKey();\n  }\n\n  getEncryptionPublicKey() {\n    return Buffer.from(this._key.publicKey).toString('base64')\n  }\n\n  async storeEncryptionPublicKey() {\n    return this.set(encryptionKey, this.getEncryptionPublicKey());\n  }\n\n  /**\n    capture new keys in the keystore\n   */\n  async onKeyAdded() {\n    if (!this._tmpKey) {\n      throw new Error('The key is not initialized yet');\n    }\n    await this._keyStore.setKey(this._networkId, this.accountId, this._tmpKey);\n    this._tmpKey = null;\n  }\n\n  /**\n   * enforces that the app is ready\n   * @returns {Promise<void>}\n   */\n  async forceReady() {\n    if (!await this.ready()) {\n      throw new Error('Not ready yet');\n    }\n  }\n\n  /**\n    wrap a call in a Promise for async handling?\n\n    @param {Function} call the function to be wrapped in a Promise\n    @return {Promise} the Promise to return\n   */\n  wrappedCall(call) {\n    this.blocking = this.blocking.then(() => call()).catch(() => call());\n    return this.blocking;\n  }\n\n  /**\n    unbox encrypted messages with our secret key\n    @param {string} msg64 encrypted message encoded as Base64\n    @return {string} decoded contents of the box\n   */\n  decryptSecretBox(msg64) {\n    const buf = Buffer.from(msg64, 'base64');\n    const nonce = new Uint8Array(nacl.secretbox.nonceLength);\n    buf.copy(nonce, 0, 0, nonce.length);\n    const box = new Uint8Array(buf.length - nacl.secretbox.nonceLength);\n    buf.copy(box, 0, nonce.length);\n    const decodedBuf = nacl.secretbox.open(box, nonce, this._key.secretKey);\n    return Buffer.from(decodedBuf).toString()\n  }\n\n  /**\n    box an unencrypted message with our secret key\n    @param {string} str the message to wrap in a box\n    @return {string} base64 encoded box of incoming message\n   */\n  encryptSecretBox(str) {\n    const buf = Buffer.from(str);\n    const nonce = nacl.randomBytes(nacl.secretbox.nonceLength);\n    const box = nacl.secretbox(buf, nonce, this._key.secretKey);\n\n    const fullBuf = new Uint8Array(box.length + nacl.secretbox.nonceLength);\n    fullBuf.set(nonce);\n    fullBuf.set(box, nacl.secretbox.nonceLength);\n    return Buffer.from(fullBuf).toString('base64')\n  }\n\n  /**\n   unbox encrypted messages with our secret key\n   @param {string} msg64 encrypted message encoded as Base64\n   @param {Uint8Array} theirPublicKey the public key to use to verify the message\n   @return {string} decoded contents of the box\n   */\n  decryptBox(msg64, theirPublicKey) {\n    if (theirPublicKey.length !== nacl.box.publicKeyLength) {\n      throw new Error(\"Given encryption public key is invalid.\");\n    }\n    const buf = Buffer.from(msg64, 'base64');\n    const nonce = new Uint8Array(nacl.box.nonceLength);\n    buf.copy(nonce, 0, 0, nonce.length);\n    const box = new Uint8Array(buf.length - nacl.box.nonceLength);\n    buf.copy(box, 0, nonce.length);\n    const decodedBuf = nacl.box.open(box, nonce, theirPublicKey, this._key.secretKey);\n    return Buffer.from(decodedBuf).toString()\n  }\n\n  /**\n   box an unencrypted message with their public key and sign it with our secret key\n   @param {string} str the message to wrap in a box\n   @param {Uint8Array} theirPublicKey the public key to use to encrypt the message\n   @returns {string} base64 encoded box of incoming message\n   */\n  encryptBox(str, theirPublicKey) {\n    if (theirPublicKey.length !== nacl.box.publicKeyLength) {\n      throw new Error(\"Given encryption public key is invalid.\");\n    }\n    const buf = Buffer.from(str);\n    const nonce = nacl.randomBytes(nacl.box.nonceLength);\n    const box = nacl.box(buf, nonce, theirPublicKey, this._key.secretKey);\n\n    const fullBuf = new Uint8Array(box.length + nacl.box.nonceLength);\n    fullBuf.set(nonce);\n    fullBuf.set(box, nacl.box.nonceLength);\n    return Buffer.from(fullBuf).toString('base64')\n  }\n\n  /**\n    get data from a local app.  apps can decide whether or not to encrypt their contents\n\n    @param {string} key the key used to store a value in the app\n    @param {object} options to specify:\n    - {bool} `encrypted` flag indicating whether or not the value is box encrypted. Default false.\n    - {string} `appId` the name of the app. Same app by default.\n    @return {string} the value returned by the local app\n   */\n  async get(key, options) {\n    options = Object.assign({\n      encrypted: false,  // not supported yet\n      appId: this.appId,\n    }, options);\n    let str = await this._contract.get({\n      app_id: options.appId,\n      key,\n    });\n    if (str) {\n      str = JSON.parse(options.encrypted ? this.decryptSecretBox(str) : str);\n    }\n    return str;\n  }\n\n  /**\n    get a value from a remote app installed on another account\n\n    @param {string} accountId account from which to get a value\n    @param {string} key the key to use to identify the value\n    @param {object} options to specify:\n     - {bool} `encrypted` flag indicating whether or not the value is box encrypted. Default false.\n     - {string} `appId` the name of the app. Same app by default.\n    @return {string} the value returned from the remote app\n   */\n  async getFrom(accountId, key, options) {\n    options = Object.assign({\n      encrypted: false,  // not supported yet\n      appId: this.appId,\n    }, options);\n    const account = new nearlib.Account(this._near.connection, accountId);\n    const contract = new nearlib.Contract(account, accountId, {\n      viewMethods: ['get'],\n      changeMethods: [],\n      sender: this.accountId\n    });\n\n    let str = await contract.get({\n      app_id: options.appId,\n      key,\n    });\n    if (str) {\n      str = JSON.parse(options.encrypted ? this.decryptSecretBox(str) : str);\n    }\n    return str;\n  }\n\n  /**\n    return a list of installed apps\n    @return {object} collection of installed apps\n   */\n  async apps() {\n    return await this._contract.apps();\n  }\n\n  /**\n    set a value in local storage\n\n    @param {string} key identifier for the value to be set\n    @param {string} value the value to be set\n    @param {object} options to specify:\n      - {bool} `encrypted` flag indicating whether to encrypt (box) the value. Default false.\n   */\n  async set(key, value, options) {\n    await this.forceReady();\n    options = Object.assign({\n      encrypted: false,\n    }, options);\n    await this.wrappedCall(() => this._contract.set({\n      key,\n      value: options.encrypted ? this.encryptSecretBox(JSON.stringify(value)) : JSON.stringify(value),\n    }, GAS));\n  }\n\n  /**\n    remove a key-value pair from local storage\n\n    @param {string} key key to be removed\n   */\n  async remove(key) {\n    await this.forceReady();\n    await this.wrappedCall(() => this._contract.remove({\n      key,\n    }, GAS));\n  }\n\n  /**\n    retrieve a message\n\n    @return {any} return async? pull from local storage, null if not found\n   */\n  async pullMessage(options) {\n    await this.forceReady();\n    if (await this._contract.num_messages({app_id: this.appId}) > 0) {\n      return await this.wrappedCall(() => this._contract.pull_message({}, GAS));\n    } else {\n      return null;\n    }\n  }\n\n  async getTheirPublicKey(options) {\n    options = Object.assign({\n      accountId: null,\n      theirPublicKey: null,\n      theirPublicKey64: null,\n      encryptionKey,\n      appId: this.appId,\n    }, options);\n    if (options.theirPublicKey) {\n      return options.theirPublicKey;\n    }\n    if (!options.theirPublicKey64) {\n      if (!options.accountId) {\n        throw new Error(\"Either accountId or theirPublicKey64 has to be provided\");\n      }\n      options.theirPublicKey64 = await this.getFrom(options.accountId, options.encryptionKey, {\n        appId: options.appId,\n      });\n    }\n    if (!options.theirPublicKey64) {\n      throw new Error(\"Their app doesn't provide the encryption public key.\");\n    }\n    const buf = Buffer.from(options.theirPublicKey64, 'base64');\n    if (buf.length !== nacl.box.publicKeyLength) {\n      throw new Error(\"Their encryption public key is invalid.\");\n    }\n    const theirPublicKey = new Uint8Array(nacl.box.publicKeyLength);\n    theirPublicKey.set(buf);\n    return theirPublicKey;\n  }\n\n  /**\n   * Encrypts given content. Typical usage: encryptMessage(\"hello world\", {accountId: bla})\n   *\n   * @param {string} content The message to encrypt\n   * @param options\n   * @returns {Promise<string>}\n   */\n  async encryptMessage(content, options) {\n    const theirPublicKey = await this.getTheirPublicKey(options);\n    return this.encryptBox(content, theirPublicKey);\n  }\n\n  async decryptMessage(msg64, options) {\n    const theirPublicKey = await this.getTheirPublicKey(options);\n    return this.decryptBox(msg64, theirPublicKey);\n  }\n\n  /**\n    send a message to another account\n\n    @param {string} receiverId account id which will receive the message\n    @param {string} message the content of the message\n    @param {object} options to specify:\n      - {string} `appId` the app ID to receive the message. Same app by default.\n   */\n  async sendMessage(receiverId, message, options) {\n    this.forceReady();\n    options = Object.assign({\n      appId: this.appId,\n    }, options);\n    await this.wrappedCall(() => this._contract.send_message({\n      receiver_id: receiverId,\n      app_id: options.appId,\n      message,\n    }, GAS));\n  }\n}\n","module.exports = __webpack_public_path__ + \"static/media/anon.5cbbd243.png\";","module.exports = __webpack_public_path__ + \"static/media/gray_near_logo.55517b93.svg\";","module.exports = __webpack_public_path__ + \"static/media/encryptionOn.23e3b306.png\";","module.exports = __webpack_public_path__ + \"static/media/encryptionOff.475ce496.png\";","(function() {\n    const CONTRACT_NAME = 'react-template'; /* TODO: fill this in!*/\n    const DEFAULT_ENV = 'development'; \n    \n    function getConfig(env) {\n        switch (env) {\n\n        case 'production':\n        case 'development':\n            return {\n                networkId: 'default',\n                nodeUrl: 'https://rpc.nearprotocol.com',\n                contractName: CONTRACT_NAME,\n                walletUrl: 'https://wallet.nearprotocol.com',\n            };\n        case 'staging':\n            return {\n                networkId: 'staging',\n                nodeUrl: 'https://staging-rpc.nearprotocol.com/',\n                contractName: CONTRACT_NAME,\n                walletUrl: 'https://near-wallet-staging.onrender.com',\n            };\n        case 'local':\n            return {\n                networkId: 'local',\n                nodeUrl: 'http://localhost:3030',\n                keyPath: `${process.env.HOME}/.near/validator_key.json`,\n                walletUrl: 'http://localhost:4000/wallet',\n                contractName: CONTRACT_NAME,\n            };\n        case 'test':\n            return {\n                networkId: 'local',\n                nodeUrl: 'http://localhost:3030',\n                contractName: CONTRACT_NAME,\n                masterAccount: 'test.near',\n            };\n        case 'test-remote':\n        case 'ci':\n            return {\n                networkId: 'shared-test',\n                nodeUrl: 'http://shared-test.nearprotocol.com:3030',\n                contractName: CONTRACT_NAME,\n                masterAccount: 'test.near',\n            };\n        case 'ci-staging':\n            return {\n                networkId: 'shared-test-staging',\n                nodeUrl: 'http://staging-shared-test.nearprotocol.com:3030',\n                contractName: CONTRACT_NAME,\n                masterAccount: 'test.near',\n            };\n        default:\n            throw Error(`Unconfigured environment '${env}'. Can be configured in src/config.js.`);\n        }\n    }\n    \n    let Cookies = require('js-cookie');\n    const cookieConfig = typeof Cookies != 'undefined' && Cookies.getJSON('fiddleConfig');\n    if (typeof module !== 'undefined' && module.exports) {\n        module.exports = getConfig;\n    } else {\n        window.nearConfig =  cookieConfig && cookieConfig.nearPages ? cookieConfig : getConfig(DEFAULT_ENV);\n    }\n})();\n"],"sourceRoot":""}
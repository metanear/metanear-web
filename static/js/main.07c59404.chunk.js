(this["webpackJsonpnear-open-web-frontend"]=this["webpackJsonpnear-open-web-frontend"]||[]).push([[0],{105:function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var a=n(13),r=n(14),s=n(18),i=n(17),c=n(19),o=n(0),u=n.n(o),l=n(28),p=n.n(l),h=n(35),d={profile:{display:"none"}},f=function(e){function t(e){var n;return Object(a.a)(this,t),(n=Object(s.a)(this,Object(i.a)(t).call(this,e))).state={displayName:"",profileUrl:p.a},n}return Object(c.a)(t,e),Object(r.a)(t,[{key:"onProfile",value:function(e){this.setState({displayName:e&&e.displayName||"",profileUrl:e&&e.profileUrl||p.a})}},{key:"render",value:function(){var e=this,t=this.props.message,n=t.text,a=t.senderId,r=function(e){var t=new Date(e);return(new Date).getDate()===t.getDate()?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString()}(t.time),s=this.props.showMeta&&u.a.createElement(h.Profile,{accountId:a,styles:d,onFetch:function(t){return e.onProfile(t)}});return u.a.createElement("div",{className:"chat-message"+(this.props.pending?" chat-message-pending":"")+(this.props.showMeta?"":" chat-message-no-meta")},s,u.a.createElement("img",{className:"chat-message-profile",src:this.state.profileUrl,alt:"Profile @".concat(a)}),u.a.createElement("div",{className:"chat-message-content"},u.a.createElement("div",{className:"chat-message-meta"},u.a.createElement("div",{className:"chat-message-sender-name"},this.state.displayName||"@"+a),this.state.displayName&&u.a.createElement("div",{className:"chat-message-sender-id"},"(@"+a+")"),this.props.pending?u.a.createElement("div",{className:"chat-message-time"},u.a.createElement("span",{className:"spinner-grow spinner-grow-sm",role:"status","aria-hidden":"true"})," sending"):u.a.createElement("div",{className:"chat-message-time"},r)),n))}}]),t}(u.a.Component)},177:function(e,t,n){e.exports=n.p+"static/media/gray_near_logo.55517b93.svg"},179:function(e,t,n){e.exports=n.p+"static/media/encryptionOn.23e3b306.png"},180:function(e,t,n){e.exports=n.p+"static/media/encryptionOff.475ce496.png"},186:function(e,t,n){!function(){function t(e){switch(e){case"production":case"development":return{networkId:"default",nodeUrl:"https://rpc.nearprotocol.com",contractName:"react-template",walletUrl:"https://wallet.nearprotocol.com"};case"staging":return{networkId:"staging",nodeUrl:"https://staging-rpc.nearprotocol.com/",contractName:"react-template",walletUrl:"https://near-wallet-staging.onrender.com"};case"local":return{networkId:"local",nodeUrl:"http://localhost:3030",keyPath:"".concat(Object({NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0}).HOME,"/.near/validator_key.json"),walletUrl:"http://localhost:4000/wallet",contractName:"react-template"};case"test":return{networkId:"local",nodeUrl:"http://localhost:3030",contractName:"react-template",masterAccount:"test.near"};case"test-remote":case"ci":return{networkId:"shared-test",nodeUrl:"http://shared-test.nearprotocol.com:3030",contractName:"react-template",masterAccount:"test.near"};case"ci-staging":return{networkId:"shared-test-staging",nodeUrl:"http://staging-shared-test.nearprotocol.com:3030",contractName:"react-template",masterAccount:"test.near"};default:throw Error("Unconfigured environment '".concat(e,"'. Can be configured in src/config.js."))}}var a=n(358),r="undefined"!=typeof a&&a.getJSON("fiddleConfig");e.exports?e.exports=t:window.nearConfig=r&&r.nearPages?r:t("development")}()},187:function(e,t,n){e.exports=n(359)},193:function(e,t,n){},207:function(e,t){},209:function(e,t){},228:function(e,t){},233:function(e,t){},260:function(e,t){},265:function(e,t){},276:function(e,t,n){},28:function(e,t,n){e.exports=n.p+"static/media/anon.5cbbd243.png"},307:function(e,t){},308:function(e,t){},359:function(e,t,n){"use strict";n.r(t);var a=n(1),r=n.n(a),s=n(2),i=n(0),c=n.n(i),o=n(176),u=n.n(o),l=n(13),p=n(14),h=n(18),d=n(17),f=n(19),m=n(183),g=n(41),y=n(40),v=n(36),b=n(177),w=n.n(b),k=(n(193),n(21)),x=n(74),I=n(38),E=n(28),S=n.n(E),O=n(178),_=n.n(O),N=n(35),j=function(e){function t(e){var n;Object(l.a)(this,t);var a=["displayName","profileUrl","bio"];return(n=Object(h.a)(this,Object(d.a)(t).call(this,e))).state=a.reduce((function(e,t){return e[t]="",e.chainValues[t]=null,e}),{keys:a,chainValues:{},initialized:!1,saving:!1,hasChanges:!1,appReady:!1}),n}return Object(f.a)(t,e),Object(p.a)(t,[{key:"init",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:n=this.state.keys.reduce((function(e,n){return e[n]=t[n]||"",e.chainValues[n]=e[n],e}),{chainValues:{}}),this.setState(n);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"maybeInit",value:function(){var e=this;this.props.app&&!this.state.initialized&&(this.setState({initialized:!0}),this.props.app.waitReady().then((function(){e.setState({appReady:!0})})))}},{key:"componentDidMount",value:function(){this.maybeInit()}},{key:"componentDidUpdate",value:function(e){this.maybeInit()}},{key:"handleChange",value:function(e,t){this.setState(Object(I.a)({},e,t))}},{key:"hasChanges",value:function(){var e=this;return this.state.keys.some((function(t){return e.state.chainValues[t]!==e.state[t]}))}},{key:"save",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n,a=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.setState({saving:!0}),console.log("Saving"),t=Object.assign({},this.state.chainValues),n=[],this.state.keys.forEach((function(e){a.state.chainValues[e]!==a.state[e]&&(t[e]=a.state[e],n.push(a.props.app.set(e,a.state[e]).then((function(){console.log("Updated key `"+e+"` to value `"+a.state[e]+"`")}))))})),Promise.all(n).then((function(){a.setState({chainValues:t,saving:!1})}));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"onFilesChange",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var n,a,s=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=new Image,(a=new FileReader).readAsDataURL(t[0]),n.onload=function(){var e=document.createElement("canvas"),t=n.naturalWidth/n.naturalHeight,a=Math.round(96*Math.max(1,t)),r=Math.round(96*Math.max(1,1/t));e.width=96,e.height=96;var i=e.getContext("2d");i.imageSmoothingQuality="high",i.fillStyle="#fff",i.fillRect(0,0,96,96),i.drawImage(n,(96-a)/2,(96-r)/2,a,r);var c=[e.toDataURL("image/jpeg",.92),e.toDataURL("image/png")];c.sort((function(e,t){return e.length-t.length})),s.handleChange("profileUrl",c[0])},a.onload=function(e){n.src=e.target.result};case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"onFilesError",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log(t,n);case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this;return c.a.createElement("div",null,c.a.createElement("div",null,c.a.createElement("button",{className:"float-right",onClick:this.props.logOut},"Log out"),c.a.createElement(N.Profile,{accountId:this.props.app&&this.props.app.accountId,profileUrl:this.state.profileUrl,displayName:this.state.displayName,bio:this.state.bio,defaultProfileUrl:S.a,onFetch:function(t){return e.init(t)}})),c.a.createElement("hr",null),c.a.createElement("div",null,c.a.createElement("div",{className:"form-group"},c.a.createElement("label",{htmlFor:"displayName"},"Display Name"),c.a.createElement("input",{placeholder:"The REAL Satoshi",id:"displayName",className:"form-control",disabled:!this.props.app,value:this.state.displayName,onChange:function(t){return e.handleChange("displayName",t.target.value)}})),c.a.createElement("label",{htmlFor:"profileUrl"},"Profile URL"),c.a.createElement("div",{className:"input-group"},c.a.createElement("input",{placeholder:"https://metanear.com"+S.a,id:"profileUrl",className:"form-control",disabled:!this.props.app,value:this.state.profileUrl,onChange:function(t){return e.handleChange("profileUrl",t.target.value)}}),c.a.createElement("div",{className:"input-group-append"},c.a.createElement(_.a,{type:"button",className:"btn btn-outline-primary",onChange:function(t){return e.onFilesChange(t)},onError:function(t,n){return e.onFilesError(t,n)},multiple:!1,accepts:["image/*"],minFileSize:1,clickable:!0},"Click to upload"))),c.a.createElement("div",{className:"form-group"},c.a.createElement("label",{htmlFor:"bio"},"Bio"),c.a.createElement("textarea",{placeholder:"I'm working on Bitcoin, so bankers can go home.",id:"bio",className:"form-control",disabled:!this.props.app,value:this.state.bio,onChange:function(t){return e.handleChange("bio",t.target.value)}})),c.a.createElement("div",{className:"form-group"},c.a.createElement("button",{className:"btn btn-primary",disabled:this.state.saving||!this.hasChanges(),onClick:function(){return e.save()}},this.state.saving&&c.a.createElement("span",{className:"spinner-grow spinner-grow-sm",role:"status","aria-hidden":"true"})," Save changes"))))}}]),t}(c.a.Component),C=n(59),A=(n(276),{profile:{whiteSpace:"nowrap",display:"inline-block"},profileImage:{height:"2em",width:"2em",borderRadius:"50%",verticalAlign:"middle",marginRight:"0.5em"},profileName:{display:"none"},profileDisplayName:{},profileAccountId:{}}),M=function(e){function t(e){var n;return Object(l.a)(this,t),(n=Object(h.a)(this,Object(d.a)(t).call(this,e))).state={initialized:!1,appReady:!1,text:"",channelId:"public",sending:!1,currentMessage:null},n.textInput=c.a.createRef(),n}return Object(f.a)(t,e),Object(p.a)(t,[{key:"maybeInit",value:function(){var e=this;this.props.app&&!this.state.initialized&&(this.setState({initialized:!0}),this.props.app.waitReady().then((function(){e.setState({appReady:!0},(function(){e.textInput.current.focus()}))})))}},{key:"componentDidMount",value:function(){this.maybeInit()}},{key:"componentDidUpdate",value:function(e){this.maybeInit()}},{key:"handleChange",value:function(e,t){this.setState(Object(I.a)({},e,t))}},{key:"sendMessage",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Sending chat message"),t=this.state.text,this.setState({sending:!0,text:"",currentMessage:{text:t,senderId:this.props.app.accountId,time:(new Date).getTime()}}),e.prev=3,n=JSON.stringify({ChatMessage:{channel_id:this.state.channelId,text:t}}),e.next=7,this.props.app.sendMessage(C.b,n);case 7:t="",e.next=13;break;case 10:e.prev=10,e.t0=e.catch(3),console.log("Failed to send the chat message",e.t0);case 13:return e.prev=13,this.setState({text:t,sending:!1,currentMessage:null}),e.finish(13);case 16:case 17:case"end":return e.stop()}}),e,this,[[3,10,13,16]])})));return function(){return e.apply(this,arguments)}}()},{key:"onKeyDown",value:function(e){"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),this.sendMessage())}},{key:"render",value:function(){var e=this;return c.a.createElement("div",{className:"chat-app h100 cflex"},c.a.createElement("div",{className:"channels"},c.a.createElement("div",{className:"current-channel"},"#",this.state.channelId)),c.a.createElement(C.a,{channelId:this.state.channelId,app:this.props.app,currentMessage:this.state.currentMessage}),c.a.createElement("br",null),c.a.createElement("div",{className:"input-group"},c.a.createElement("div",{className:"input-group-prepend"},this.state.appReady&&c.a.createElement(N.Profile,{accountId:this.props.app.accountId,defaultProfileUrl:S.a,styles:A})),c.a.createElement("input",{ref:this.textInput,id:"text",placeholder:"Message #"+this.state.channelId,className:"form-control form-control",disabled:!this.state.appReady||this.state.sending,value:this.state.text,onKeyDown:function(t){return e.onKeyDown(t)},onChange:function(t){return e.handleChange("text",t.target.value)}}),c.a.createElement("div",{className:"input-group-append"},c.a.createElement("button",{className:"btn btn-primary",disabled:!this.state.appReady||this.state.sending,onClick:function(){return e.sendMessage()}},this.state.sending&&c.a.createElement("span",{className:"spinner-grow spinner-grow-sm",role:"status","aria-hidden":"true"})," Send"))))}}]),t}(c.a.Component),K=n(179),P=n.n(K),L=n(180),D=n.n(L),U=function(e){function t(e){var n;return Object(l.a)(this,t),(n=Object(h.a)(this,Object(d.a)(t).call(this,e))).state={initialized:!1,receiverId:"",subject:"",content:"",sending:!1,numLetters:0,unread:0,expandedId:-1,profileFound:!1,profileLoading:!1,keyLoading:!1,theirPublicKey64:null,inbox:[]},n.textarea=c.a.createRef(),n.keyCache={},n}return Object(f.a)(t,e),Object(p.a)(t,[{key:"modifyLetter",value:function(e,t){if(void 0===t){if(!e)return;t=e.messageId}var n=this.state.inbox.filter((function(e){return e.messageId!==t}));e&&n.push(e),n.sort((function(e,t){return t.time-e.time}));var a=n.reduce((function(e,t){return e+(t.read?0:1)}),0);this.setState({inbox:n,unread:a}),this.props.onUnread(a)}},{key:"migrateFrom",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var n,a,s,i,c=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t){e.next=19;break}return console.log("Migrating from version #0"),n=0,e.prev=3,e.next=6,this.props.app.get("numLetters");case 6:n=e.sent,e.next=11;break;case 9:e.prev=9,e.t0=e.catch(3);case 11:for(a=[],s=function(e){a.push(c.props.app.get("letter_"+e).then((function(t){return t?c.props.app.set("letter_"+e,t,{encrypted:!0}).then((function(){console.log("Migrated letter #"+e)})):Promise.resolve()})).catch((function(t){return console.log("Can't migrate letter #",e,t)})))},i=0;i<n;++i)s(i);return e.next=16,Promise.all(a);case 16:return e.next=18,this.props.app.set("numLetters",n,{encrypted:!0});case 18:t++;case 19:if(1!==t){e.next=24;break}return console.log("Migrating from version #1"),e.next=23,this.props.app.storeEncryptionPublicKey();case 23:t++;case 24:return e.next=26,this.props.app.set("version",t,{encrypted:!0});case 26:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(t){return e.apply(this,arguments)}}()},{key:"init",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n,a,s=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.props.app.get("version",{encrypted:!0});case 3:if(e.t0=e.sent,e.t0){e.next=6;break}e.t0=0;case 6:t=e.t0,e.next=13;break;case 9:return e.prev=9,e.t1=e.catch(0),console.log(e.t1),e.abrupt("return");case 13:if(!(t<2)){e.next=16;break}return e.next=16,this.migrateFrom(t);case 16:return e.next=18,this.props.app.get("numLetters",{encrypted:!0});case 18:if(e.t2=e.sent,e.t2){e.next=21;break}e.t2=0;case 21:for(n=e.t2,this.setState({numLetters:n}),a=Math.max(0,n-10);a<n;++a)this.props.app.get("letter_"+a,{encrypted:!0}).then((function(e){return s.modifyLetter(e)}));this.fetchMessages();case 25:case"end":return e.stop()}}),e,this,[[0,9]])})));return function(){return e.apply(this,arguments)}}()},{key:"maybeInit",value:function(){var e=this;this.props.app&&!this.state.initialized&&(this.setState({initialized:!0}),this.props.app.waitReady().then((function(){return e.init()})))}},{key:"componentDidMount",value:function(){this.maybeInit()}},{key:"componentDidUpdate",value:function(e){this.maybeInit()}},{key:"fetchKey",value:function(){var e=Object(s.a)(r.a.mark((function e(t){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t in this.keyCache)){e.next=6;break}return e.next=3,this.keyCache[t];case 3:return e.abrupt("return",e.sent);case 6:return console.log("Fetching key for "+t),this.keyCache[t]=this.props.app.getStoredEncryptionPublicKey(t,{}).catch((function(e){return!1})),e.next=10,this.keyCache[t];case 10:return e.abrupt("return",e.sent);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateKey",value:function(e){var t=this;this.props.app&&(this.setState({profileLoading:!1,profileFound:!!e}),e&&(this.setState({keyLoading:!0}),this.fetchKey(e.accountId).then((function(e){t.setState({keyLoading:!1,theirPublicKey64:e})}))))}},{key:"handleChange",value:function(e,t){var n=Object(I.a)({},e,t);"receiverId"===e&&(t=t.toLowerCase().replace(/[^a-z0-9\-_.]/,""),n[e]=t,n.profileLoading=!0,n.theirPublicKey64=!1),this.setState(n)}},{key:"fetchMessages",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n,a,s,i,c,o,u=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.props.app){e.next=2;break}return e.abrupt("return");case 2:return this.fetchTimeoutId&&(clearTimeout(this.fetchTimeoutId),this.fetchTimeoutId=null),console.log("Fetching messages"),e.next=6,this.props.app.pullMessage();case 6:if(t=e.sent){e.next=10;break}return this.fetchTimeoutId=setTimeout((function(){u.fetchMessages()}),6e4),e.abrupt("return");case 10:if(e.prev=10,console.log(t),n=JSON.parse(t.message),a="encrypted"===n.type,s=n.fromAppId||this.props.app.appId,!a){e.next=20;break}return e.next=18,this.props.app.decryptMessage(n.content,{accountId:t.sender,appId:n.fromAppId});case 18:i=e.sent,n=JSON.parse(i);case 20:"mail"===n.type?(c={messageId:this.state.numLetters,isEncrypted:a,fromAppId:s,sender:t.sender,subject:n.subject,content:n.content,time:Math.trunc(t.time/1e6)},o=this.state.numLetters+1,this.setState({numLetters:o}),this.props.app.set("letter_"+c.messageId,c,{encrypted:!0}).then((function(){console.log("Saved the letter: ",c)})),this.props.app.set("numLetters",o,{encrypted:!0}).then((function(){console.log("Saved the new number of letters: ",o)})),this.modifyLetter(c)):console.warn("Unknown message",t),e.next=26;break;case 23:e.prev=23,e.t0=e.catch(10),console.error(e.t0);case 26:return e.prev=26,this.fetchMessages(),e.finish(26);case 29:case"end":return e.stop()}}),e,this,[[10,23,26,29]])})));return function(){return e.apply(this,arguments)}}()},{key:"sendMail",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n,a=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state.profileFound){e.next=2;break}return e.abrupt("return");case 2:if(console.log("Sending mail"),this.setState({sending:!0}),e.prev=4,t=JSON.stringify({type:"mail",subject:this.state.subject,content:this.state.content}),!this.state.theirPublicKey64){e.next=11;break}return e.next=9,this.props.app.encryptMessage(t,{theirPublicKey64:this.state.theirPublicKey64});case 9:n=e.sent,t=JSON.stringify({type:"encrypted",fromAppId:this.props.app.appId,content:n});case 11:return e.next=13,this.props.app.sendMessage(this.state.receiverId,t);case 13:this.setState({subject:"",content:""}),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(4),console.log("Failed to send the message",e.t0);case 19:return e.prev=19,this.setState({sending:!1}),setTimeout((function(){return a.fetchMessages()}),2e3),e.finish(19);case 23:case 24:case"end":return e.stop()}}),e,this,[[4,16,19,23]])})));return function(){return e.apply(this,arguments)}}()},{key:"receiverClass",value:function(){return!this.state.receiverId||this.state.profileLoading?"form-control":this.state.profileFound?"form-control is-valid":"form-control is-invalid"}},{key:"replyTo",value:function(e,t){var n=this;this.handleChange("receiverId",e.sender),this.setState({subject:(e.subject.startsWith("Re: ")?"":"Re: ")+e.subject,content:["","",["On",new Date(e.time).toLocaleDateString(),t,"@"+e.sender,"wrote:"].join(" ")].concat(Object(y.a)(e.content.split(/\r?\n/).map((function(e){return"| "+e})))).join("\n")},(function(){n.textarea.current.focus(),n.textarea.current.setSelectionRange(0,0),n.textarea.current.scrollLeft=0,n.textarea.current.scrollTop=0}))}},{key:"selectLetter",value:function(e){this.setState({expandedId:this.state.expandedId===e.messageId?-1:e.messageId}),e.read||((e=JSON.parse(JSON.stringify(e))).read=!0,this.props.app.set("letter_"+e.messageId,e,{encrypted:!0}).then((function(){console.log("Saved the letter: ",e)})),this.modifyLetter(e))}},{key:"deleteLetter",value:function(e){this.props.app.remove("letter_"+e.messageId).then((function(){console.log("Deleted the letter: ",e)})),this.modifyLetter(null,e.messageId)}},{key:"render",value:function(){var e=this,t=this.state.theirPublicKey64,n=this.state.profileFound&&!this.state.keyLoading,a=t?"Encryption is ON":"Not secure! Encryption is OFF",r=n&&c.a.createElement("img",{className:"encryption-icon",src:t?P.a:D.a,title:a,alt:a}),s=c.a.createElement(N.Profile,{accountId:this.state.receiverId,onFetch:function(t){return e.updateKey(t)},defaultProfileUrl:S.a}),i=this.state.inbox.map((function(t,n){return c.a.createElement(R,{key:t.messageId,letter:t,expanded:t.messageId===e.state.expandedId,deleteLetter:function(t){return e.deleteLetter(t)},replyTo:function(t,n){return e.replyTo(t,n)},selectLetter:function(t){return e.selectLetter(t)}})}));return c.a.createElement("div",null,"Inbox ",c.a.createElement("button",{className:"btn btn-sm",onClick:function(){return e.fetchMessages()}},c.a.createElement("span",{role:"img","aria-label":"Refresh"},"\ud83d\udd04")),c.a.createElement("div",null,i),c.a.createElement("h3",null,"Send"),c.a.createElement("div",{className:"form-row"},c.a.createElement("div",{className:"col"},c.a.createElement("div",{className:"form-group"},c.a.createElement("label",{className:"sr-only",htmlFor:"toAccountId"},"To Account ID"),c.a.createElement("div",{className:"input-group"},c.a.createElement("div",{className:"input-group-prepend"},c.a.createElement("div",{className:"input-group-text"},"@")),c.a.createElement("input",{type:"text",className:this.receiverClass(),id:"toAccountId",placeholder:"To Account ID",value:this.state.receiverId,disabled:!this.props.app,onChange:function(t){return e.handleChange("receiverId",t.target.value)}})))),s),c.a.createElement("div",{className:"form-group"},c.a.createElement("label",{className:"sr-only",htmlFor:"subject"},"Subject"),c.a.createElement("input",{type:"text",className:"form-control",id:"subject",placeholder:"Subject",disabled:!this.props.app,value:this.state.subject,onChange:function(t){return e.handleChange("subject",t.target.value)}})),c.a.createElement("div",{className:"form-group"},c.a.createElement("textarea",{ref:this.textarea,id:"content",className:"form-control",rows:"7",disabled:!this.props.app,value:this.state.content,onChange:function(t){return e.handleChange("content",t.target.value)}})),c.a.createElement("div",{className:"form-group"},c.a.createElement("button",{className:"form-control form-control-lg btn "+(n&&!t?"btn-danger":"btn-primary"),disabled:!this.state.profileFound||this.state.sending,onClick:function(){return e.sendMail()}},"Send ",r)))}}]),t}(c.a.Component),R=function(e){function t(e){var n;return Object(l.a)(this,t),(n=Object(h.a)(this,Object(d.a)(t).call(this,e))).state={profile:{profileUrl:null,displayName:"@"+e.letter.sender}},n}return Object(f.a)(t,e),Object(p.a)(t,[{key:"onClick",value:function(){this.props.selectLetter(this.props.letter)}},{key:"render",value:function(){var e,t=this,n=c.a.createElement("div",{className:"col-sm-6 col-md-4 col-lg-4 letter-profile"},c.a.createElement(N.Profile,{accountId:this.props.letter.sender,onFetch:function(e){return e&&t.setState({displayName:e.displayName})},defaultProfileUrl:S.a})),a=c.a.createElement("div",{className:"col-sm-4 col-md"},c.a.createElement("div",{className:"letter-subject"},this.props.letter.subject)),r=this.props.expanded?c.a.createElement("div",{className:"col-sm-2 col-lg-2"},c.a.createElement("div",{className:"letter-time"},(e=this.props.letter.time,new Date(e).toLocaleString()))):c.a.createElement("div",{className:"col-sm-2 col-lg-1 d-none d-md-block"},c.a.createElement("div",{className:"letter-time"},function(e){var t=new Date(e);if((new Date).getDate()===t.getDate()){var n=t.getHours()%12,a=t.getMinutes().toString().padStart(2,"0"),r=t.getHours()>=12?"PM":"AM";return"".concat(n,":").concat(a," ").concat(r)}return t.toLocaleDateString()}(this.props.letter.time)));return this.props.expanded?c.a.createElement("div",{className:"letter letter-expanded"},c.a.createElement("div",{className:"row letter-expanded-header",onClick:function(){return t.onClick()}},n,a,r),c.a.createElement("div",{className:"letter-content-expanded"},c.a.createElement("pre",null,this.props.letter.content),c.a.createElement("div",{className:"row"},c.a.createElement("div",{className:"col-sm"},c.a.createElement("button",{className:"btn btn-primary",onClick:function(){return t.props.replyTo(t.props.letter,t.state.displayName)}},"Reply")),c.a.createElement("div",{className:"col-sm"},c.a.createElement("button",{className:"btn btn-danger float-right",onClick:function(){return t.props.deleteLetter(t.props.letter)}},"DELETE THIS!"))))):c.a.createElement("div",{className:"row letter letter-small"+(this.props.letter.read?" letter-read":" letter-unread"),onClick:function(){return t.onClick()}},n,a,c.a.createElement("div",{className:"col-sm d-none d-lg-block"},c.a.createElement("div",{className:"letter-content"},this.props.letter.content)),r)}}]),t}(c.a.Component);var T=n(37),F=(n(277),n(181)),W=/^(([a-z\d]+[-_])*[a-z\d]+\.)*([a-z\d]+[-_])*[a-z\d]+$/,z="meta-faucet-auth-data",J=function(e){function t(e){var n;return Object(l.a)(this,t),(n=Object(h.a)(this,Object(d.a)(t).call(this,e))).state={connected:!1,signedIn:!1,accountId:null,newAccountId:"",creating:!1,accountLoading:!1,newAccountExists:!1,computingProofOfWork:!1},n}return Object(f.a)(t,e),Object(p.a)(t,[{key:"componentWillUnmount",value:function(){this.mounted=!1}},{key:"componentDidMount",value:function(){var e=this;this.mounted=!0,this.initNear().then((function(){e.mounted&&e.setState({connected:!0,signedIn:!!e._authData.accountId,accountId:e._authData.accountId})}))}},{key:"initFaucet",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._keyStore.getKey(this._nearConfig.networkId,"meta");case 2:if(e.sent){e.next=7;break}return t=k.KeyPair.fromString("ed25519:2Rtn6ms22rCRMgmGgLRSPPd6gYDCgWDuFrX6gERknSA8GKiCHE5L9Rksc1ihsSCDvMSptfbipzq29H7cDZhR1Ze3"),e.next=7,this._keyStore.setKey(this._nearConfig.networkId,"meta",t);case 7:return n=new k.Account(this._near.connection,"meta"),this._faucetContract=new k.Contract(n,"meta",{viewMethods:["get_min_difficulty","get_account_suffix","get_num_created_accounts"],changeMethods:["create_account"],sender:"meta"}),e.next=11,this._faucetContract.get_account_suffix();case 11:return this._accountSuffix=e.sent,e.next=14,this._faucetContract.get_min_difficulty();case 14:if(this._minDifficulty=e.sent,e.t0=this.mounted,!e.t0){e.next=23;break}return e.t1=this,e.next=20,this._faucetContract.get_num_created_accounts();case 20:e.t2=e.sent,e.t3={numCreatedAccounts:e.t2},e.t1.setState.call(e.t1,e.t3);case 23:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"initNear",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n,a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t={networkId:"default",nodeUrl:"https://rpc.nearprotocol.com",contractName:"meta",walletUrl:"https://wallet.nearprotocol.com"},n=new k.keyStores.BrowserLocalStorageKeyStore,e.next=4,k.connect(Object.assign({deps:{keyStore:n}},t));case 4:return a=e.sent,this._keyStore=n,this._nearConfig=t,this._near=a,this._authData=JSON.parse(window.localStorage.getItem(z)||"{}"),e.next=11,this.initFaucet();case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"handleChange",value:function(e,t){var n=this,a=Object(I.a)({},e,t);"newAccountId"===e&&(t=t.toLowerCase().replace(/[^a-z0-9\-_.]/,""),a[e]=t,a.newAccountExists=!1,this.isValidAccount(t)&&(a.accountLoading=!0,this._near.connection.provider.query("account/".concat(t+this._accountSuffix),"").then((function(e){n.state.newAccountId===t&&n.setState({accountLoading:!1,newAccountExists:!0})})).catch((function(e){n.state.newAccountId===t&&n.setState({accountLoading:!1,newAccountExists:!1})})))),this.setState(a)}},{key:"isValidAccount",value:function(e){if(e.includes("."))return!1;var t=e+this._accountSuffix;return t.length>=2&&t.length<=64&&t.match(W)}},{key:"newAccountClass",value:function(){return!this.state.newAccountId||this.state.accountLoading?"form-control form-control-large":!this.state.newAccountExists&&this.isValidAccount(this.state.newAccountId)?"form-control form-control-large is-valid":"form-control form-control-large is-invalid"}},{key:"computeProofOfWork",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n){var a,s,i,c,o,u,l,p,h,d;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(s=Object(y.a)(new TextEncoder("utf-8").encode(t+":"))).push(0),(a=s).push.apply(a,Object(y.a)(n.data)),s.push(":".charCodeAt(0)),s.push(0,0,0,0,0,0,0,0),s=new Uint8Array(s),i=s.length,c=0,o=0;case 9:return e.t0=Uint8Array,e.next=12,crypto.subtle.digest("SHA-256",s);case 12:e.t1=e.sent,u=new e.t0(e.t1),l=0,p=0;case 16:if(!(p<u.length)){e.next=24;break}if(h=Math.clz32(u[p])-24,l+=h,!(h<8)){e.next=21;break}return e.abrupt("break",24);case 21:++p,e.next=16;break;case 24:if(!(l>=this._minDifficulty)){e.next=29;break}return this.setState({computingProofOfWork:!1}),e.abrupt("return",o);case 29:l>c?(c=l,this.setState({proofOfWorkProgress:Math.trunc(100*c/this._minDifficulty),proofOfWorkDifficulty:c,proofOfWorkSalt:o})):o%1e4===0&&this.setState({proofOfWorkSalt:o});case 30:d=i-8;case 31:if(!(d<i)){e.next=41;break}if(255!==s[d]){e.next=36;break}s[d]=0,e.next=38;break;case 36:return++s[d],e.abrupt("break",41);case 38:++d,e.next=31;break;case 41:++o,e.next=9;break;case 44:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"createAccount",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n,a,s;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setState({creating:!0,computingProofOfWork:!0,proofOfWorkProgress:0,proofOfWorkDifficulty:0,proofOfWorkSalt:0}),t=this.state.newAccountId+this._accountSuffix,n=Object(F.generateSeedPhrase)(),a=k.KeyPair.fromString(n.secretKey),e.next=6,this.computeProofOfWork(t,a.getPublicKey());case 6:return s=e.sent,e.next=9,this._faucetContract.create_account({account_id:t,public_key:[0].concat(Object(y.a)(a.getPublicKey().data)),salt:s});case 9:return e.next=11,this._keyStore.setKey(this._nearConfig.networkId,t,a);case 11:return this._authData={accountId:t,seed:n},window.localStorage.setItem(z,JSON.stringify(this._authData)),e.t0=this,e.t1=t,e.next=17,this._faucetContract.get_num_created_accounts();case 17:e.t2=e.sent,e.t3={signedIn:!0,accountId:e.t1,creating:!1,numCreatedAccounts:e.t2},e.t0.setState.call(e.t0,e.t3),this.props.onLogin(this._authData);case 21:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"moveAccountToWallet",value:function(){window.location="https://wallet.nearprotocol.com/recover-with-link/".concat(this._authData.accountId,"/").concat(this._authData.seed.seedPhrase)}},{key:"logout",value:function(){window.localStorage.removeItem(z),this._authData={},this.setState({signedIn:!1,accountId:null,newAccountId:"",creating:!1,accountLoading:!1,newAccountExists:!1,computingProofOfWork:!1})}},{key:"render",value:function(){var e=this,t=this.state.connected?this.state.signedIn?c.a.createElement("div",null,c.a.createElement("h3",null,"Hello, ",this.state.accountId),c.a.createElement("div",{className:"form-group"},c.a.createElement("button",{className:"btn btn-success",onClick:function(){return e.moveAccountToWallet()}},"Move account to NEAR Wallet")),c.a.createElement("div",{className:"form-group"},c.a.createElement("button",{className:"btn btn-danger",onClick:function(){return e.logout()}},"Logout from Faucet"))):c.a.createElement("div",null,c.a.createElement("div",{className:"form-group"},c.a.createElement("div",{className:"input-group"},c.a.createElement("div",{className:"input-group-prepend"},c.a.createElement("div",{className:"input-group-text"},"@")),c.a.createElement("input",{placeholder:"bob",id:"accountId",className:this.newAccountClass(),value:this.state.newAccountId,onChange:function(t){return e.handleChange("newAccountId",t.target.value)},disabled:this.state.creating}),c.a.createElement("div",{className:"input-group-append"},c.a.createElement("div",{className:"input-group-text"},this._accountSuffix)))),this.state.newAccountExists&&c.a.createElement("div",{className:"alert alert-warning",role:"alert"},"Account ",'"'+this.state.newAccountId+this._accountSuffix+'"'," already exists!"),c.a.createElement("div",{className:"form-group"},c.a.createElement("button",{className:"btn btn-primary",disabled:this.state.creating||this.state.accountLoading||this.state.newAccountExists||!this.isValidAccount(this.state.newAccountId),onClick:function(){return e.createAccount()}},(this.state.creating||this.state.accountLoading)&&c.a.createElement("span",{className:"spinner-grow spinner-grow-sm",role:"status","aria-hidden":"true"})," Create Account ",this.isValidAccount(this.state.newAccountId)?'"'+this.state.newAccountId+this._accountSuffix+'"':"")),this.state.creating&&c.a.createElement("div",null,this.state.computingProofOfWork?c.a.createElement("div",null,"Computing Proof of Work. Done ",this.state.proofOfWorkSalt," operations.",c.a.createElement("div",{className:"progress"},c.a.createElement("div",{className:"progress-bar",role:"progressbar",style:{width:this.state.proofOfWorkProgress+"%"},"aria-valuenow":this.state.proofOfWorkProgress,"aria-valuemin":"0","aria-valuemax":"100"},this.state.proofOfWorkDifficulty," out of ",this._minDifficulty))):c.a.createElement("div",null,"Proof of Work is Done! Creating account ",'"'+this.state.newAccountId+this._accountSuffix+'"'))):c.a.createElement("div",null,"Connecting... ",c.a.createElement("span",{className:"spinner-grow spinner-grow-sm",role:"status","aria-hidden":"true"}));return c.a.createElement("div",null,c.a.createElement("h3",null,"or create a new account"),t)}}]),t}(c.a.Component),H=function(e){function t(e){var n;return Object(l.a)(this,t),(n=Object(h.a)(this,Object(d.a)(t).call(this,e))).selectTab=function(e){window.localStorage.setItem("metanearDefaultTabIndex",JSON.stringify(e)),n.setState({defaultTabIndex:e})},n.state={login:!1,apps:{},logs:[],mailUnread:0,chatUnread:0,loading:!1,defaultTabIndex:JSON.parse(window.localStorage.getItem("metanearDefaultTabIndex")||"0"),offlineChatApp:null},n.signedInFlow=n.signedInFlow.bind(Object(v.a)(n)),n.requestSignIn=n.requestSignIn.bind(Object(v.a)(n)),n.requestSignOut=n.requestSignOut.bind(Object(v.a)(n)),n.signedOutFlow=n.signedOutFlow.bind(Object(v.a)(n)),n.checkSignIn=n.checkSignIn.bind(Object(v.a)(n)),n.initOpenWebApp=n.initOpenWebApp.bind(Object(v.a)(n)),window.nearlib=k,n}return Object(f.a)(t,e),Object(p.a)(t,[{key:"componentDidMount",value:function(){this.checkSignIn()}},{key:"checkSignIn",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=window.walletAccount.isSignedIn(),n=JSON.parse(window.localStorage.getItem(z)||"{}"),!t&&!n.accountId){e.next=7;break}return e.next=5,this.signedInFlow(n);case 5:e.next=8;break;case 7:this.signedOutFlow();case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"log",value:function(e){console.log(e),this.setState({logs:this.state.logs.concat([e])})}},{key:"signedInFlow",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var n,a,s,i,c,o,u,l;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.accountId,e.t0){e.next=5;break}return e.next=4,this.props.wallet.getAccountId();case 4:e.t0=e.sent;case 5:return n=e.t0,this.setState({login:!0,loading:!0,accountId:n}),window.location.search.includes("account_id")&&window.location.replace(window.location.origin+window.location.pathname),window.location.search.includes("all_keys")&&window.location.replace(window.location.origin+window.location.pathname),this.log("Connecting to account..."),e.next=12,new k.Account(window.near.connection,n);case 12:return a=e.sent,this.log("Querying state..."),e.next=16,a.state();case 16:if(s=e.sent,console.log(s),"C8UmYSqATkuyhheJ7i7ryxPjfZL4nV8PfkovdMKitsmJ"===s.code_hash){e.next=41;break}return this.log("Going to deploy the code"),this.log("Downloading started..."),e.next=23,fetch("/open_web.wasm");case 23:return i=e.sent,e.next=26,i.arrayBuffer();case 26:return c=e.sent,this.log("Downloading done. Deploying contract..."),e.next=30,a.deployContract(new Uint8Array(c));case 30:if("11111111111111111111111111111111"!==s.code_hash){e.next=40;break}return this.log("Deploying done. Initializing contract..."),e.next=34,new k.Contract(a,n,{viewMethods:[],changeMethods:["new"],sender:n});case 34:return o=e.sent,e.t1=console,e.next=38,o.new();case 38:e.t2=e.sent,e.t1.log.call(e.t1,e.t2);case 40:this.log("The contract is deployed");case 41:return e.next=43,new k.Contract(a,n,{viewMethods:["apps"],changeMethods:["add_app_key","remove_app_key"],sender:n});case 43:return u=e.sent,this.masterContract=u,window.masterContract=u,this.log("Fetching authorized apps..."),e.t3=console,e.next=50,u.apps();case 50:return e.t4=e.sent,e.t3.log.call(e.t3,"Apps:",e.t4),this.log("Initializing local apps..."),e.next=55,this.initOpenWebApp("profile",n);case 55:return e.t5=e.sent,e.next=58,this.initOpenWebApp("chat",n);case 58:return e.t6=e.sent,e.next=61,this.initOpenWebApp("mail",n);case 61:e.t7=e.sent,l={profile:e.t5,chat:e.t6,mail:e.t7},window.apps=l,this.apps=l,this.setState({apps:l,loading:!1});case 66:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"initOpenWebApp",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n){var a,s,i,c;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Initializing app: "+t+" ..."),a=new x.OpenWebApp(t,n,window.nearConfig),e.next=4,a.init();case 4:return e.next=6,a.ready();case 6:if(e.sent){e.next=19;break}return e.next=9,a.getAccessPublicKey();case 9:return s=e.sent,this.log("Authorizing app for key "+s.toString()+" ..."),e.next=13,a.getSerializedAccessPublicKey();case 13:return i=e.sent,c={public_key:Object(y.a)(i),app_id:t},e.next=17,this.masterContract.add_app_key(c,2e15);case 17:return e.next=19,a.onKeyAdded();case 19:return e.abrupt("return",a);case 20:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"requestSignIn",value:function(){var e=Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return"Open Web Home",e.next=3,this.props.wallet.requestSignIn("","Open Web Home");case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"requestSignOut",value:function(){this.props.wallet.signOut(),setTimeout(this.signedOutFlow,500),console.log("after sign out",this.props.wallet.isSignedIn())}},{key:"signedOutFlow",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(window.location.search.includes("account_id")&&window.location.replace(window.location.origin+window.location.pathname),this.setState({login:!1}),this.state.offlineChatApp){e.next=7;break}return t=new x.OpenWebApp("chat",null,window.nearConfig),e.next=6,t.init();case 6:this.setState({offlineChatApp:t});case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this,t=this.state.mailUnread+this.state.chatUnread;return document.title=(t?"(".concat(t,") "):"")+"Meta NEAR - User-centric web",this.state.login?this.state.loading?c.a.createElement("div",{className:"loading-div"},c.a.createElement("div",{className:"spinner-grow loading-spinner",role:"status"},c.a.createElement("span",{className:"sr-only"},"Loading...")),c.a.createElement("pre",{className:"text-left"},this.state.logs.join("\n"))):c.a.createElement("div",{className:"h100 apps"+(this.state.loading?" d-none":"")},c.a.createElement(T.d,{className:"h100 cflex",forceRenderTabPanel:!0,defaultIndex:this.state.defaultTabIndex,onSelect:function(t){return e.selectTab(t)}},c.a.createElement(T.b,null,c.a.createElement(T.a,null,"Profile"),c.a.createElement(T.a,null,"Public Chat ",this.state.chatUnread?"(".concat(this.state.chatUnread,")"):""),c.a.createElement(T.a,null,"Mail ",this.state.mailUnread?"(".concat(this.state.mailUnread,")"):"")),c.a.createElement(T.c,null,c.a.createElement(j,{app:this.state.apps.profile,logOut:this.requestSignOut})),c.a.createElement(T.c,{style:{flexGrow:"1"}},c.a.createElement(M,{app:this.state.apps.chat,onUnread:function(t){return e.setState({chatUnread:t})}})),c.a.createElement(T.c,null,c.a.createElement(U,{app:this.state.apps.mail,onUnread:function(t){return e.setState({mailUnread:t})}})))):c.a.createElement("div",{className:"App-header"},c.a.createElement("div",null,c.a.createElement("div",{className:"image-wrapper"},c.a.createElement("img",{className:"logo",src:w.a,alt:"NEAR logo"})),c.a.createElement("div",null,c.a.createElement("button",{className:"btn btn-primary",onClick:this.requestSignIn},"Log in with NEAR Wallet")),c.a.createElement(J,{onLogin:this.signedInFlow}),c.a.createElement("hr",null),c.a.createElement("div",null,c.a.createElement("h3",null,"To join #public chat "),c.a.createElement(C.a,{channelId:"public",app:this.state.offlineChatApp}))))}}]),t}(i.Component),B=n(182),V=n.n(B),q=function(e){function t(e){var n;Object(l.a)(this,t),n=Object(h.a)(this,Object(d.a)(t).call(this,e));var a=V.a.parse(n.props.location.search),r=a.app_id,s=a.pub_key;return n.state=r&&s?{authorized:!1,new_app_id:r,new_pub_key:s}:{authorized:!1,new_app_id:"",new_pub_key:""},n}return Object(f.a)(t,e),Object(p.a)(t,[{key:"componentDidMount",value:function(){var e=this;!this.props.loading&&this.state.new_app_id&&this.state.new_pub_key&&this.props.initOpenWebApp(this.state.new_app_id,this.state.new_pub_key).then((function(t){e.setState({authorized:!0})}))}},{key:"componentDidUpdate",value:function(e){this.props.app&&this.state.initialized}},{key:"render",value:function(){return c.a.createElement("div",null,this.state.authorized?c.a.createElement("div",null,c.a.createElement("p",null,"App ",c.a.createElement("strong",null,this.state.new_app_id)," was added"),c.a.createElement("p",null," Using the public key: ",this.state.new_pub_key," ")):"You need pass a key in order to add an app")}}]),t}(c.a.Component),G=function(e){function t(){return Object(l.a)(this,t),Object(h.a)(this,Object(d.a)(t).apply(this,arguments))}return Object(f.a)(t,e),Object(p.a)(t,[{key:"render",value:function(){var e=this;return c.a.createElement(m.a,{basename:"",hashType:"noslash"},c.a.createElement(g.c,null,c.a.createElement(g.a,{exact:!0,path:"/",component:function(){return c.a.createElement(H,e.props)}}),c.a.createElement(g.a,{path:"/auth",component:function(){return c.a.createElement(q,e.props)}})))}}]),t}(i.Component),Y=n(186),Z=n.n(Y);function Q(){return(Q=Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return window.nearConfig=Z()("development"),e.next=3,k.connect(Object.assign({deps:{keyStore:new k.keyStores.BrowserLocalStorageKeyStore}},window.nearConfig));case 3:window.near=e.sent,window.walletAccount=new k.WalletAccount(window.near),window.accountId=window.walletAccount.getAccountId();case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}window.nearInitPromise=function(){return Q.apply(this,arguments)}().then((function(){u.a.render(c.a.createElement(G,{contract:window.contract,wallet:window.walletAccount}),document.getElementById("root"))})).catch(console.error)},59:function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return m}));var a=n(1),r=n.n(a),s=n(2),i=n(13),c=n(14),o=n(18),u=n(17),l=n(19),p=n(0),h=n.n(p),d=n(105),f="metanear-chat",m=function(t){function n(e){var t;return Object(i.a)(this,n),(t=Object(o.a)(this,Object(u.a)(n).call(this,e))).state={initialized:!1,appReady:!1,messages:[]},t.channelId=null,t.channelHash=null,t.cachedRanges=null,t.cachedMessages={},t.fetchingMessages=!1,t.fetchTimeoutId=null,t.channelInnerRef=h.a.createRef(),t.mounted=!1,t}return Object(l.a)(n,t),Object(c.a)(n,[{key:"loadCache",value:function(){var t=Object(s.a)(r.a.mark((function t(n){var a,s,i=this;return r.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=new TextEncoder("utf-8"),s=a.encode("c:"+n),this.channelId=n,this.cachedMessages={},t.t0=e,t.next=7,crypto.subtle.digest("SHA-256",s);case 7:t.t1=t.sent,this.channelHash=t.t0.from.call(t.t0,t.t1).toString("base64"),this.cachedRanges=JSON.parse(window.localStorage.getItem(this.channelHash+":cachedRanges")||"null")||[],this.cachedRanges.forEach((function(e){for(var t=e.first;t<e.last;++t)i.cachedMessages[t]=JSON.parse(window.localStorage.getItem(i.channelHash+":m:"+t)||"null")})),this.updateState(!0);case 12:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"scrollDown",value:function(){this.channelInnerRef.current.scrollTop=this.channelInnerRef.current.scrollHeight}},{key:"updateState",value:function(e){var t=this;this.mounted&&this.setState({messages:Object.values(this.cachedMessages)},(function(){e&&t.scrollDown()}))}},{key:"maybeInit",value:function(){var e=this;if(this.props.channelId&&this.channelId!==this.props.channelId){var t=this.loadCache(this.props.channelId);this.state.appReady&&t.then((function(){e.fetchNewMessages()}))}this.props.app&&!this.state.initialized&&(this.setState({initialized:!0,appReady:!0}),this.fetchNewMessages())}},{key:"componentDidMount",value:function(){this.maybeInit(),this.mounted=!0}},{key:"componentDidUpdate",value:function(e){var t=this;this.maybeInit(),this.props.currentMessage&&setTimeout((function(){t.scrollDown()}),10),!this.props.currentMessage&&e.currentMessage&&this.fetchNewMessages()}},{key:"componentWillUnmount",value:function(){this.mounted=!1,this.fetchTimeoutId&&(clearTimeout(this.fetchTimeoutId),this.fetchTimeoutId=null)}},{key:"addNewMessage",value:function(e,t){if(e===this.channelId){var n=t.index;n in this.cachedMessages||(this.cachedMessages[n]=t,window.localStorage.setItem(this.channelHash+":m:"+n,JSON.stringify(t)),this.cachedRanges.push({first:n,last:n+1}),this.cachedRanges.sort((function(e,t){return e.first-t.first})),this.cachedRanges=this.cachedRanges.reduce((function(e,t){return t.first===t.last||(e.length||e.push(t),e[e.length-1].last===t.first&&(e[e.length-1].last=t.last)),e}),[]),window.localStorage.setItem(this.channelHash+":cachedRanges",JSON.stringify(this.cachedRanges)))}}},{key:"fetchMessages",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n,a){var s=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Math.max(n,a-10),e.next=3,this.props.app.getFrom(f,JSON.stringify({ChannelMessages:{channel_id:t,from_index:n,limit:a-n}}),{});case 3:e.sent.messages.forEach((function(e,a){s.addNewMessage(t,{index:n+a,senderId:e.sender_id,text:e.text,time:e.time})}));case 5:case"end":return e.stop()}}),e,this)})));return function(t,n,a){return e.apply(this,arguments)}}()},{key:"fetchNewMessages",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n,a,s,i=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.fetchingMessages){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,this.fetchingMessages=!0,this.fetchTimeoutId&&(clearTimeout(this.fetchTimeoutId),this.fetchTimeoutId=null),console.log("Fetching chat messages"),t=this.channelId,e.next=9,this.props.app.getFrom(f,JSON.stringify({ChannelStatus:{channel_id:t}}),{});case 9:if(n=e.sent,a=n.num_messages,!((s=this.cachedRanges.length?this.cachedRanges[this.cachedRanges.length-1].last:0)<a)){e.next=16;break}return e.next=15,this.fetchMessages(t,s,a);case 15:this.updateState(!0);case 16:return e.prev=16,this.fetchingMessages=!1,this.mounted&&(this.fetchTimeoutId=setTimeout((function(){return i.fetchNewMessages()}),2e3)),e.finish(16);case 20:case"end":return e.stop()}}),e,this,[[2,,16,20]])})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this,t=null;return h.a.createElement("div",{className:"channel fgrow",ref:this.channelInnerRef},this.state.messages.map((function(n){var a=h.a.createElement(d.a,{key:e.channelHash+n.index,message:n,onReply:function(){return e.onReply(n)},showMeta:!t||n.senderId!==t.senderId||n.time-t.time>3e5});return t=n,a})),this.props.currentMessage&&h.a.createElement(d.a,{key:"currentMessage",message:this.props.currentMessage,pending:!0,showMeta:!0}))}}]),n}(h.a.Component)}).call(this,n(6).Buffer)},74:function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"encryptionKey",(function(){return l})),n.d(t,"OpenWebApp",(function(){return p}));var a=n(1),r=n.n(a),s=n(2),i=n(13),c=n(14),o=n(32),u=n(8),l="encryptionKey",p=function(){function t(n,a,r){Object(i.a)(this,t),this.appId=n,this.accountId=a,this._nearConfig=r,this.blocking=Promise.resolve(),this.parseEncryptionKey(),window.nacl=u,window.Buffer=e}return Object(c.a)(t,[{key:"parseEncryptionKey",value:function(){var t="enc_key:"+this.accountId+":"+this.appId+":",n=localStorage.getItem(t);if(n){var a=e.from(n,"base64");if(a.length!==u.box.secretKeyLength)throw new Error("Given secret key has wrong length");n=u.box.keyPair.fromSecretKey(a)}else n=new u.box.keyPair,localStorage.setItem(t,e.from(n.secretKey).toString("base64"));this._key=n}},{key:"updateEncryptionKey",value:function(t){var n=e.from(t,"base64");if(n.length!==u.box.secretKeyLength)throw new Error("Given secret key has wrong length");var a=u.box.keyPair.fromSecretKey(n);this._key=a;var r="enc_key:"+this.accountId+":"+this.appId+":";localStorage.setItem(r,e.from(a.secretKey).toString("base64"))}},{key:"_innerInit",value:function(){var e=Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._keyStore=new o.keyStores.BrowserLocalStorageKeyStore(localStorage,"app:"+this.appId+":"),e.next=3,o.connect(Object.assign({deps:{keyStore:this._keyStore}},this._nearConfig));case 3:return this._near=e.sent,this._account=new o.Account(this._near.connection,this.accountId),this._contract=new o.Contract(this._account,this.accountId,{viewMethods:["get","apps","num_messages"],changeMethods:["set","remove","pull_message","send_message"],sender:this.accountId}),this._networkId=this._nearConfig.networkId,e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"init",value:function(){var e=Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._init||(this._init=this._innerInit()));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"ready",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this._keyStore.getKey(this._networkId,this.accountId);case 4:return t=e.sent,e.abrupt("return",!!t);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"waitReady",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready();case 2:if(e.t1=e.sent,e.t1){e.next=5;break}e.t1=this._ready;case 5:if(e.t0=e.t1,e.t0){e.next=8;break}e.t0=this._ready=new Promise((function(e){t._keyAwait=e}));case 8:return e.abrupt("return",e.t0);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getAccessPublicKey",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._keyStore.getKey(this._networkId,this.accountId);case 2:if(!(t=e.sent)){e.next=5;break}return e.abrupt("return",t.getPublicKey());case 5:if(!this._tmpKey){e.next=7;break}return e.abrupt("return",this._tmpKey.getPublicKey());case 7:return n=o.KeyPair.fromRandom("ed25519"),this._tmpKey=n,e.abrupt("return",n.getPublicKey());case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getSerializedAccessPublicKey",value:function(){var e=Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=o.utils.serialize,e.t1=o.transactions.SCHEMA,e.next=4,this.getAccessPublicKey();case 4:return e.t2=e.sent,e.abrupt("return",e.t0.serialize.call(e.t0,e.t1,e.t2));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getStoredEncryptionPublicKey",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.getFrom(t||this.accountId,l,n));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getEncryptionPublicKey",value:function(){return e.from(this._key.publicKey).toString("base64")}},{key:"storeEncryptionPublicKey",value:function(){var e=Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.set(l,this.getEncryptionPublicKey()));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"onKeyAdded",value:function(){var e=Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._tmpKey){e.next=2;break}throw new Error("The key is not initialized yet");case 2:return e.next=4,this._keyStore.setKey(this._networkId,this.accountId,this._tmpKey);case 4:this._tmpKey=null,this._keyAwait&&this._keyAwait();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"forceReady",value:function(){var e=Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready();case 2:if(e.sent){e.next=4;break}throw new Error("Not ready yet");case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"wrappedCall",value:function(e){return this.blocking=this.blocking.then((function(){return e()})).catch((function(){return e()})),this.blocking}},{key:"decryptSecretBox",value:function(t){var n=e.from(t,"base64"),a=new Uint8Array(u.secretbox.nonceLength);n.copy(a,0,0,a.length);var r=new Uint8Array(n.length-u.secretbox.nonceLength);n.copy(r,0,a.length);var s=u.secretbox.open(r,a,this._key.secretKey);return e.from(s).toString()}},{key:"encryptSecretBox",value:function(t){var n=e.from(t),a=u.randomBytes(u.secretbox.nonceLength),r=u.secretbox(n,a,this._key.secretKey),s=new Uint8Array(r.length+u.secretbox.nonceLength);return s.set(a),s.set(r,u.secretbox.nonceLength),e.from(s).toString("base64")}},{key:"decryptBox",value:function(t,n){if(n.length!==u.box.publicKeyLength)throw new Error("Given encryption public key is invalid.");var a=e.from(t,"base64"),r=new Uint8Array(u.box.nonceLength);a.copy(r,0,0,r.length);var s=new Uint8Array(a.length-u.box.nonceLength);a.copy(s,0,r.length);var i=u.box.open(s,r,n,this._key.secretKey);return e.from(i).toString()}},{key:"encryptBox",value:function(t,n){if(n.length!==u.box.publicKeyLength)throw new Error("Given encryption public key is invalid.");var a=e.from(t),r=u.randomBytes(u.box.nonceLength),s=u.box(a,r,n,this._key.secretKey),i=new Uint8Array(s.length+u.box.nonceLength);return i.set(r),i.set(s,u.box.nonceLength),e.from(i).toString("base64")}},{key:"get",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object.assign({encrypted:!1,appId:this.appId},n),e.next=3,this._contract.get({app_id:n.appId,key:t});case 3:return(a=e.sent)&&(a=JSON.parse(n.encrypted?this.decryptSecretBox(a):a)),e.abrupt("return",a);case 6:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getFrom",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n,a){var s,i,c;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object.assign({encrypted:!1,appId:this.appId},a),s=new o.Account(this._near.connection,t),i=new o.Contract(s,t,{viewMethods:["get"],changeMethods:[],sender:this.accountId}),e.next=5,i.get({app_id:a.appId,key:n});case 5:return(c=e.sent)&&(c=JSON.parse(a.encrypted?this.decryptSecretBox(c):c)),e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,a){return e.apply(this,arguments)}}()},{key:"apps",value:function(){var e=Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._contract.apps();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"set",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n,a){var s=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.forceReady();case 2:return a=Object.assign({encrypted:!1},a),e.next=5,this.wrappedCall((function(){return s._contract.set({key:t,value:a.encrypted?s.encryptSecretBox(JSON.stringify(n)):JSON.stringify(n)},2e15)}));case 5:case"end":return e.stop()}}),e,this)})));return function(t,n,a){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var n=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.forceReady();case 2:return e.next=4,this.wrappedCall((function(){return n._contract.remove({key:t},2e15)}));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"pullMessage",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.forceReady();case 2:return e.next=4,this._contract.num_messages({app_id:this.appId});case 4:if(e.t0=e.sent,!(e.t0>0)){e.next=11;break}return e.next=8,this.wrappedCall((function(){return t._contract.pull_message({},2e15)}));case 8:return e.abrupt("return",e.sent);case 11:return e.abrupt("return",null);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getTheirPublicKey",value:function(){var t=Object(s.a)(r.a.mark((function t(n){var a,s;return r.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(n=Object.assign({accountId:null,theirPublicKey:null,theirPublicKey64:null,encryptionKey:l,appId:this.appId},n)).theirPublicKey){t.next=3;break}return t.abrupt("return",n.theirPublicKey);case 3:if(n.theirPublicKey64){t.next=9;break}if(n.accountId){t.next=6;break}throw new Error("Either accountId or theirPublicKey64 has to be provided");case 6:return t.next=8,this.getFrom(n.accountId,n.encryptionKey,{appId:n.appId});case 8:n.theirPublicKey64=t.sent;case 9:if(n.theirPublicKey64){t.next=11;break}throw new Error("Their app doesn't provide the encryption public key.");case 11:if((a=e.from(n.theirPublicKey64,"base64")).length===u.box.publicKeyLength){t.next=14;break}throw new Error("Their encryption public key is invalid.");case 14:return(s=new Uint8Array(u.box.publicKeyLength)).set(a),t.abrupt("return",s);case 17:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"encryptMessage",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getTheirPublicKey(n);case 2:return a=e.sent,e.abrupt("return",this.encryptBox(t,a));case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"decryptMessage",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getTheirPublicKey(n);case 2:return a=e.sent,e.abrupt("return",this.decryptBox(t,a));case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"sendMessage",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n,a){var s=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.forceReady(),a=Object.assign({appId:this.appId},a),e.next=4,this.wrappedCall((function(){return s._contract.send_message({receiver_id:t,app_id:a.appId,message:n},2e15)}));case 4:case"end":return e.stop()}}),e,this)})));return function(t,n,a){return e.apply(this,arguments)}}()}]),t}()}.call(this,n(6).Buffer)}},[[187,1,2]]]);
//# sourceMappingURL=main.07c59404.chunk.js.map